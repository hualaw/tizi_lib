function getAst(ast,options){return isString(ast)?UglifyJS.parse(ast,options||{}):ast}function parse(ast){ast=getAst(ast);var meta=[],walker=new UglifyJS.TreeWalker(function(node){if(node instanceof UglifyJS.AST_Call&&"define"===node.expression.name){var define=getDefine(node);return define&&meta.push(define),!0}});return ast.walk(walker),meta}function modify(ast,options){ast=getAst(ast);var idfn,depfn,requirefn,asyncfn;if(isFunction(options)?idfn=depfn=requirefn=asyncfn=options:(idfn=options.id,depfn=options.dependencies,requirefn=options.require,asyncfn=options.async),isObject(depfn)){var alias=depfn;depfn=function(value){return alias.hasOwnProperty(value)?alias[value]:value}}var trans=new UglifyJS.TreeTransformer(function(node){if((idfn||depfn)&&node instanceof UglifyJS.AST_Call&&"define"===node.expression.name&&node.args.length){var args=[],meta=getDefine(node);if(idfn&&isFunction(idfn)?meta.id=idfn(meta.id):idfn&&isString(idfn)&&(meta.id=idfn),meta.id&&args.push(new UglifyJS.AST_String({value:meta.id})),meta.dependencyNode&&!depfn)args.push(meta.dependencyNode);else if(depfn){var elements=[];meta.dependencies.length&&isFunction(depfn)?meta.dependencies.forEach(function(d){var value=depfn(d);value&&elements.push(new UglifyJS.AST_String({value:value}))}):isString(depfn)?elements=[new UglifyJS.AST_String({value:depfn})]:Array.isArray(depfn)&&(elements=depfn.map(function(value){return new UglifyJS.AST_String({value:value})})),meta.dependencyNode?args.push(new UglifyJS.AST_Array({start:meta.dependencyNode.start,end:meta.dependencyNode.end,elements:elements})):args.push(new UglifyJS.AST_Array({elements:elements}))}else args.push(new UglifyJS.AST_Array({elements:[]}));return meta.factory&&args.push(meta.factory),node.args=args,node}});return ast=ast.transform(trans),(requirefn||asyncfn)&&(ast=replaceRequire(ast,requirefn,asyncfn)),ast}function getDefine(node){var id,factory,dependencyNode,dependencies=[];if(node instanceof UglifyJS.AST_Call&&"define"===node.expression.name){if(!node.args||!node.args.length)return null;if(1===node.args.length)factory=node.args[0],factory instanceof UglifyJS.AST_Function&&(dependencies=getRequires(factory));else if(2===node.args.length){factory=node.args[1];var child=node.args[0];child instanceof UglifyJS.AST_Array&&(dependencies=map(child.elements,function(el){return el instanceof UglifyJS.AST_String?el.getValue():void 0}),dependencyNode=child),child instanceof UglifyJS.AST_String&&(id=child.getValue(),dependencies=getRequires(factory))}else{factory=node.args[2];var firstChild=node.args[0],secondChild=node.args[1];firstChild instanceof UglifyJS.AST_String&&(id=firstChild.getValue()),secondChild instanceof UglifyJS.AST_Array?(dependencies=map(secondChild.elements,function(el){return el instanceof UglifyJS.AST_String?el.getValue():void 0}),dependencyNode=secondChild):(secondChild instanceof UglifyJS.AST_Null||secondChild instanceof UglifyJS.AST_Undefined)&&factory instanceof UglifyJS.AST_Function&&(dependencies=getRequires(factory))}}return{id:id,dependencies:dependencies,factory:factory,dependencyNode:dependencyNode}}function getRequires(ast){ast=getAst(ast);var deps=[],walker=new UglifyJS.TreeWalker(function(node){if(node instanceof UglifyJS.AST_Call&&"require"===node.expression.name){var args=node.expression.args||node.args;if(args&&1===args.length){var child=args[0];child instanceof UglifyJS.AST_String&&deps.push(child.getValue())}return!0}});return ast.walk(walker),deps}function replaceRequire(ast,requirefn,asyncfn){ast=getAst(ast);var makeFunction=function(fn){if(!fn)return fn;if(isObject(fn)){var alias=fn;fn=function(value){return alias.hasOwnProperty(value)?alias[value]:value}}return fn},replaceChild=function(node,fn){var child=node.args[0];if(child instanceof UglifyJS.AST_String){var childNode=new UglifyJS.AST_String({start:child.start,end:child.end,value:fn(child.getValue())});return node.args=[childNode],node}};requirefn=makeFunction(requirefn),asyncfn=makeFunction(asyncfn);var trans=new UglifyJS.TreeTransformer(function(node){return asyncfn&&node instanceof UglifyJS.AST_Call&&"require"===node.start.value&&"async"===node.expression.property&&1==node.args.length?replaceChild(node,asyncfn):requirefn&&node instanceof UglifyJS.AST_Call&&"require"===node.expression.name&&1===node.args.length?replaceChild(node,requirefn):void 0});return ast.transform(trans)}function isString(str){return"string"==typeof str}function isFunction(fn){return"function"==typeof fn}function isObject(obj){return"object"==typeof obj&&!Array.isArray(obj)}function map(obj,fn,context){var results=[];if(null===obj)return results;if(obj.map===Array.prototype.map)return obj.map(fn,context);for(var i=0;i<obj.length;i++)results[i]=fn.call(context,obj[i],i,obj);return results}var UglifyJS=require("uglify-js");exports.getAst=getAst,exports.parse=parse,exports.parseFirst=function(ast){return parse(ast)[0]},exports.modify=modify;