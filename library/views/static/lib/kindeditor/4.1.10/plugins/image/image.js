KindEditor.plugin("image",function(K){var self=this,name="image",allowImageUpload=K.undef(self.allowImageUpload,!0),allowImageRemote=K.undef(self.allowImageRemote,!0),formatUploadUrl=K.undef(self.formatUploadUrl,!0),allowFileManager=K.undef(self.allowFileManager,!1),uploadJson=K.undef(self.uploadJson,self.basePath+"php/upload_json.php"),imageTabIndex=K.undef(self.imageTabIndex,0),imgPath=self.pluginsPath+"image/images/",extraParams=K.undef(self.extraFileUploadParams,{}),filePostName=K.undef(self.filePostName,"imgFile"),fillDescAfterUploadImage=K.undef(self.fillDescAfterUploadImage,!1),lang=self.lang(name+".");self.plugin.imageDialog=function(options){function setSize(width,height){widthBox.val(width),heightBox.val(height),originalWidth=width,originalHeight=height}var showRemote=(options.imageUrl,K.undef(options.imageWidth,""),K.undef(options.imageHeight,""),K.undef(options.imageTitle,""),K.undef(options.imageAlign,""),K.undef(options.showRemote,!0)),showLocal=K.undef(options.showLocal,!0),tabIndex=K.undef(options.tabIndex,0),clickFn=options.clickFn,target="kindeditor_upload_iframe_"+(new Date).getTime(),hiddenElements=[];for(var k in extraParams)hiddenElements.push('<input type="hidden" name="'+k+'" value="'+extraParams[k]+'" />');var tabs,html=['<div style="padding:20px;">','<div class="tabs"></div>','<div class="tab1" style="display:none;">','<div class="ke-dialog-row">','<label for="remoteUrl" style="width:60px;">'+lang.remoteUrl+"</label>",'<input type="text" id="remoteUrl" class="ke-input-text" name="url" value="" style="width:200px;" /> &nbsp;','<span class="ke-button-common ke-button-outer">','<input type="button" class="ke-button-common ke-button" name="viewServer" value="'+lang.viewServer+'" />',"</span>","</div>",'<div class="ke-dialog-row">','<label for="remoteWidth" style="width:60px;">'+lang.size+"</label>",lang.width+' <input type="text" id="remoteWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> ',lang.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> ','<img class="ke-refresh-btn" src="'+imgPath+'refresh.png" width="16" height="16" alt="" style="cursor:pointer;" title="'+lang.resetSize+'" />',"</div>",'<div class="ke-dialog-row">','<label style="width:60px;">'+lang.align+"</label>",'<input type="radio" name="align" class="ke-inline-block" value="" checked="checked" /> <img name="defaultImg" src="'+imgPath+'align_top.gif" width="23" height="25" alt="" />',' <input type="radio" name="align" class="ke-inline-block" value="left" /> <img name="leftImg" src="'+imgPath+'align_left.gif" width="23" height="25" alt="" />',' <input type="radio" name="align" class="ke-inline-block" value="right" /> <img name="rightImg" src="'+imgPath+'align_right.gif" width="23" height="25" alt="" />',"</div>",'<div class="ke-dialog-row">','<label for="remoteTitle" style="width:60px;">'+lang.imgTitle+"</label>",'<input type="text" id="remoteTitle" class="ke-input-text" name="title" value="" style="width:200px;" />',"</div>","</div>",'<div class="tab2" style="display:none;">','<iframe name="'+target+'" style="display:none;"></iframe>','<form class="ke-upload-area ke-form" method="post" enctype="multipart/form-data" target="'+target+'" action="'+K.addParam(uploadJson,"dir=image")+'">','<div class="ke-dialog-row">',hiddenElements.join(""),'<label style="width:60px;">'+lang.localUrl+"</label>",'<input type="text" name="localUrl" class="ke-input-text" tabindex="-1" style="width:200px;" readonly="true" /> &nbsp;','<input type="button" class="ke-upload-button" value="'+lang.upload+'" />',"</div>","</form>","</div>","</div>"].join(""),dialogWidth=showLocal||allowFileManager?450:400,dialogHeight=showLocal&&showRemote?300:250,dialog=self.createDialog({name:name,width:dialogWidth,height:dialogHeight,title:self.lang(name),body:html,yesBtn:{name:self.lang("yes"),click:function(){if(!dialog.isLoading){if(showLocal&&showRemote&&tabs&&1===tabs.selectedIndex||!showRemote)return""==uploadbutton.fileBox.val()?(alert(self.lang("pleaseSelectFile")),void 0):(dialog.showLoading(self.lang("uploadLoading")),uploadbutton.submit(),localUrlBox.val(""),void 0);var url=K.trim(urlBox.val()),width=widthBox.val(),height=heightBox.val(),title=titleBox.val(),align="";return alignBox.each(function(){return this.checked?(align=this.value,!1):void 0}),"http://"==url||K.invalidUrl(url)?(alert(self.lang("invalidUrl")),urlBox[0].focus(),void 0):/^\d*$/.test(width)?/^\d*$/.test(height)?(clickFn.call(self,url,title,width,height,0,align),void 0):(alert(self.lang("invalidHeight")),heightBox[0].focus(),void 0):(alert(self.lang("invalidWidth")),widthBox[0].focus(),void 0)}}},beforeRemove:function(){viewServerBtn.unbind(),widthBox.unbind(),heightBox.unbind(),refreshBtn.unbind()}}),div=dialog.div,urlBox=K('[name="url"]',div),localUrlBox=K('[name="localUrl"]',div),viewServerBtn=K('[name="viewServer"]',div),widthBox=K('.tab1 [name="width"]',div),heightBox=K('.tab1 [name="height"]',div),refreshBtn=K(".ke-refresh-btn",div),titleBox=K('.tab1 [name="title"]',div),alignBox=K('.tab1 [name="align"]',div);showRemote&&showLocal?(tabs=K.tabs({src:K(".tabs",div),afterSelect:function(){}}),tabs.add({title:lang.remoteImage,panel:K(".tab1",div)}),tabs.add({title:lang.localImage,panel:K(".tab2",div)}),tabs.select(tabIndex)):showRemote?K(".tab1",div).show():showLocal&&K(".tab2",div).show();var uploadbutton=K.uploadbutton({button:K(".ke-upload-button",div)[0],fieldName:filePostName,form:K(".ke-form",div),target:target,width:60,afterUpload:function(data){if(dialog.hideLoading(),0===data.error){var url=data.url;formatUploadUrl&&(url=K.formatUrl(url,"absolute")),self.afterUpload&&self.afterUpload.call(self,url,data,name),fillDescAfterUploadImage?(K(".ke-dialog-row #remoteUrl",div).val(url),K(".ke-tabs-li",div)[0].click(),K(".ke-refresh-btn",div).click()):clickFn.call(self,url,data.title,data.width,data.height,data.border,data.align)}else alert(data.message)},afterError:function(html){dialog.hideLoading(),self.errorDialog(html)}});uploadbutton.fileBox.change(function(){localUrlBox.val(uploadbutton.fileBox.val())}),allowFileManager?viewServerBtn.click(function(){self.loadPlugin("filemanager",function(){self.plugin.filemanagerDialog({viewType:"VIEW",dirName:"image",clickFn:function(url){self.dialogs.length>1&&(K('[name="url"]',div).val(url),self.afterSelectFile&&self.afterSelectFile.call(self,url),self.hideDialog())}})})}):viewServerBtn.hide();var originalWidth=0,originalHeight=0;return refreshBtn.click(function(){var tempImg=K('<img src="'+urlBox.val()+'" />',document).css({position:"absolute",visibility:"hidden",top:0,left:"-1000px"});tempImg.bind("load",function(){setSize(tempImg.width(),tempImg.height()),tempImg.remove()}),K(document.body).append(tempImg)}),widthBox.change(function(){originalWidth>0&&heightBox.val(Math.round(originalHeight/originalWidth*parseInt(this.value,10)))}),heightBox.change(function(){originalHeight>0&&widthBox.val(Math.round(originalWidth/originalHeight*parseInt(this.value,10)))}),urlBox.val(options.imageUrl),setSize(options.imageWidth,options.imageHeight),titleBox.val(options.imageTitle),alignBox.each(function(){return this.value===options.imageAlign?(this.checked=!0,!1):void 0}),showRemote&&0===tabIndex&&(urlBox[0].focus(),urlBox[0].select()),dialog},self.plugin.image={edit:function(){var img=self.plugin.getSelectedImage();self.plugin.imageDialog({imageUrl:img?img.attr("data-ke-src"):"http://",imageWidth:img?img.width():"",imageHeight:img?img.height():"",imageTitle:img?img.attr("title"):"",imageAlign:img?img.attr("align"):"",showRemote:allowImageRemote,showLocal:allowImageUpload,tabIndex:img?0:imageTabIndex,clickFn:function(url,title,width,height,border,align){img?(img.attr("src",url),img.attr("data-ke-src",url),img.attr("width",width),img.attr("height",height),img.attr("title",title),img.attr("align",align),img.attr("alt",title)):self.exec("insertimage",url,title,width,height,border,align),setTimeout(function(){self.hideDialog().focus()},0)}})},"delete":function(){var target=self.plugin.getSelectedImage();"a"==target.parent().name&&(target=target.parent()),target.remove(),self.addBookmark()}},self.clickToolbar(name,self.plugin.image.edit)});