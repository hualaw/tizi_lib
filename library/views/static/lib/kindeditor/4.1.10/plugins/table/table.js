KindEditor.plugin("table",function(K){function _setColor(box,color){color=color.toUpperCase(),box.css("background-color",color),box.css("color","#000000"===color?"#FFFFFF":"#000000"),box.html(color)}function _initColorPicker(dialogDiv,colorBox){function removePicker(){K.each(pickerList,function(){this.remove()}),pickerList=[],K(document).unbind("click,mousedown",removePicker),dialogDiv.unbind("click,mousedown",removePicker)}colorBox.bind("click,mousedown",function(e){e.stopPropagation()}),colorBox.click(function(){removePicker();var box=K(this),pos=box.pos(),picker=K.colorpicker({x:pos.x,y:pos.y+box.height(),z:811214,selectedColor:K(this).html(),colors:self.colorTable,noColor:self.lang("noColor"),shadowMode:self.shadowMode,click:function(color){_setColor(box,color),removePicker()}});pickerList.push(picker),K(document).bind("click,mousedown",removePicker),dialogDiv.bind("click,mousedown",removePicker)})}function _getCellIndex(table,row,cell){for(var rowSpanCount=0,i=0,len=row.cells.length;len>i&&row.cells[i]!=cell;i++)rowSpanCount+=row.cells[i].rowSpan-1;return cell.cellIndex-rowSpanCount}var self=this,name="table",lang=self.lang(name+"."),zeroborder="ke-zeroborder",pickerList=[];self.plugin.table={prop:function(isInsert){var html=['<div style="padding:20px;">','<div class="ke-dialog-row">','<label for="keRows" style="width:90px;">'+lang.cells+"</label>",lang.rows+' <input type="text" id="keRows" class="ke-input-text ke-input-number" name="rows" value="" maxlength="4" /> &nbsp; ',lang.cols+' <input type="text" class="ke-input-text ke-input-number" name="cols" value="" maxlength="4" />',"</div>",'<div class="ke-dialog-row">','<label for="keWidth" style="width:90px;">'+lang.size+"</label>",lang.width+' <input type="text" id="keWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> &nbsp; ','<select name="widthType">','<option value="%">'+lang.percent+"</option>",'<option value="px">'+lang.px+"</option>","</select> &nbsp; ",lang.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> &nbsp; ','<select name="heightType">','<option value="%">'+lang.percent+"</option>",'<option value="px">'+lang.px+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="kePadding" style="width:90px;">'+lang.space+"</label>",lang.padding+' <input type="text" id="kePadding" class="ke-input-text ke-input-number" name="padding" value="" maxlength="4" /> &nbsp; ',lang.spacing+' <input type="text" class="ke-input-text ke-input-number" name="spacing" value="" maxlength="4" />',"</div>",'<div class="ke-dialog-row">','<label for="keAlign" style="width:90px;">'+lang.align+"</label>",'<select id="keAlign" name="align">','<option value="">'+lang.alignDefault+"</option>",'<option value="left">'+lang.alignLeft+"</option>",'<option value="center">'+lang.alignCenter+"</option>",'<option value="right">'+lang.alignRight+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keBorder" style="width:90px;">'+lang.border+"</label>",lang.borderWidth+' <input type="text" id="keBorder" class="ke-input-text ke-input-number" name="border" value="" maxlength="4" /> &nbsp; ',lang.borderColor+' <span class="ke-inline-block ke-input-color"></span>',"</div>",'<div class="ke-dialog-row">','<label for="keBgColor" style="width:90px;">'+lang.backgroundColor+"</label>",'<span class="ke-inline-block ke-input-color"></span>',"</div>","</div>"].join(""),bookmark=self.cmd.range.createBookmark(),dialog=self.createDialog({name:name,width:500,title:self.lang(name),body:html,beforeRemove:function(){colorBox.unbind()},yesBtn:{name:self.lang("yes"),click:function(){var rows=rowsBox.val(),cols=colsBox.val(),width=widthBox.val(),height=heightBox.val(),widthType=widthTypeBox.val(),heightType=heightTypeBox.val(),padding=paddingBox.val(),spacing=spacingBox.val(),align=alignBox.val(),border=borderBox.val(),borderColor=K(colorBox[0]).html()||"",bgColor=K(colorBox[1]).html()||"";if(0==rows||!/^\d+$/.test(rows))return alert(self.lang("invalidRows")),rowsBox[0].focus(),void 0;if(0==cols||!/^\d+$/.test(cols))return alert(self.lang("invalidRows")),colsBox[0].focus(),void 0;if(!/^\d*$/.test(width))return alert(self.lang("invalidWidth")),widthBox[0].focus(),void 0;if(!/^\d*$/.test(height))return alert(self.lang("invalidHeight")),heightBox[0].focus(),void 0;if(!/^\d*$/.test(padding))return alert(self.lang("invalidPadding")),paddingBox[0].focus(),void 0;if(!/^\d*$/.test(spacing))return alert(self.lang("invalidSpacing")),spacingBox[0].focus(),void 0;if(!/^\d*$/.test(border))return alert(self.lang("invalidBorder")),borderBox[0].focus(),void 0;if(table)return""!==width?table.width(width+widthType):table.css("width",""),void 0!==table[0].width&&table.removeAttr("width"),""!==height?table.height(height+heightType):table.css("height",""),void 0!==table[0].height&&table.removeAttr("height"),table.css("background-color",bgColor),void 0!==table[0].bgColor&&table.removeAttr("bgColor"),""!==padding?table[0].cellPadding=padding:table.removeAttr("cellPadding"),""!==spacing?table[0].cellSpacing=spacing:table.removeAttr("cellSpacing"),""!==align?table[0].align=align:table.removeAttr("align"),""!==border?table.attr("border",border):table.removeAttr("border"),""===border||"0"===border?table.addClass(zeroborder):table.removeClass(zeroborder),""!==borderColor?table.attr("borderColor",borderColor):table.removeAttr("borderColor"),self.hideDialog().focus(),self.cmd.range.moveToBookmark(bookmark),self.cmd.select(),self.addBookmark(),void 0;var style="";""!==width&&(style+="width:"+width+widthType+";"),""!==height&&(style+="height:"+height+heightType+";"),""!==bgColor&&(style+="background-color:"+bgColor+";");var html="<table";""!==style&&(html+=' style="'+style+'"'),""!==padding&&(html+=' cellpadding="'+padding+'"'),""!==spacing&&(html+=' cellspacing="'+spacing+'"'),""!==align&&(html+=' align="'+align+'"'),""!==border&&(html+=' border="'+border+'"'),(""===border||"0"===border)&&(html+=' class="'+zeroborder+'"'),""!==borderColor&&(html+=' bordercolor="'+borderColor+'"'),html+=">";for(var i=0;rows>i;i++){html+="<tr>";for(var j=0;cols>j;j++)html+="<td>"+(K.IE?"&nbsp;":"<br />")+"</td>";html+="</tr>"}html+="</table>",K.IE||(html+="<br />"),self.insertHtml(html),self.select().hideDialog().focus(),self.addBookmark()}}}),div=dialog.div,rowsBox=K('[name="rows"]',div).val(3),colsBox=K('[name="cols"]',div).val(2),widthBox=K('[name="width"]',div).val(100),heightBox=K('[name="height"]',div),widthTypeBox=K('[name="widthType"]',div),heightTypeBox=K('[name="heightType"]',div),paddingBox=K('[name="padding"]',div).val(2),spacingBox=K('[name="spacing"]',div).val(0),alignBox=K('[name="align"]',div),borderBox=K('[name="border"]',div).val(1),colorBox=K(".ke-input-color",div);_initColorPicker(div,colorBox.eq(0)),_initColorPicker(div,colorBox.eq(1)),_setColor(colorBox.eq(0),"#000000"),_setColor(colorBox.eq(1),""),rowsBox[0].focus(),rowsBox[0].select();var table;if(!isInsert&&(table=self.plugin.getSelectedTable())){rowsBox.val(table[0].rows.length),colsBox.val(table[0].rows.length>0?table[0].rows[0].cells.length:0),rowsBox.attr("disabled",!0),colsBox.attr("disabled",!0);var match,tableWidth=table[0].style.width||table[0].width,tableHeight=table[0].style.height||table[0].height;void 0!==tableWidth&&(match=/^(\d+)((?:px|%)*)$/.exec(tableWidth))?(widthBox.val(match[1]),widthTypeBox.val(match[2])):widthBox.val(""),void 0!==tableHeight&&(match=/^(\d+)((?:px|%)*)$/.exec(tableHeight))&&(heightBox.val(match[1]),heightTypeBox.val(match[2])),paddingBox.val(table[0].cellPadding||""),spacingBox.val(table[0].cellSpacing||""),alignBox.val(table[0].align||""),borderBox.val(void 0===table[0].border?"":table[0].border),_setColor(colorBox.eq(0),K.toHex(table.attr("borderColor")||"")),_setColor(colorBox.eq(1),K.toHex(table[0].style.backgroundColor||table[0].bgColor||"")),widthBox[0].focus(),widthBox[0].select()}},cellprop:function(){var html=['<div style="padding:20px;">','<div class="ke-dialog-row">','<label for="keWidth" style="width:90px;">'+lang.size+"</label>",lang.width+' <input type="text" id="keWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> &nbsp; ','<select name="widthType">','<option value="%">'+lang.percent+"</option>",'<option value="px">'+lang.px+"</option>","</select> &nbsp; ",lang.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> &nbsp; ','<select name="heightType">','<option value="%">'+lang.percent+"</option>",'<option value="px">'+lang.px+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keAlign" style="width:90px;">'+lang.align+"</label>",lang.textAlign+' <select id="keAlign" name="textAlign">','<option value="">'+lang.alignDefault+"</option>",'<option value="left">'+lang.alignLeft+"</option>",'<option value="center">'+lang.alignCenter+"</option>",'<option value="right">'+lang.alignRight+"</option>","</select> ",lang.verticalAlign+' <select name="verticalAlign">','<option value="">'+lang.alignDefault+"</option>",'<option value="top">'+lang.alignTop+"</option>",'<option value="middle">'+lang.alignMiddle+"</option>",'<option value="bottom">'+lang.alignBottom+"</option>",'<option value="baseline">'+lang.alignBaseline+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keBorder" style="width:90px;">'+lang.border+"</label>",lang.borderWidth+' <input type="text" id="keBorder" class="ke-input-text ke-input-number" name="border" value="" maxlength="4" /> &nbsp; ',lang.borderColor+' <span class="ke-inline-block ke-input-color"></span>',"</div>",'<div class="ke-dialog-row">','<label for="keBgColor" style="width:90px;">'+lang.backgroundColor+"</label>",'<span class="ke-inline-block ke-input-color"></span>',"</div>","</div>"].join(""),bookmark=self.cmd.range.createBookmark(),dialog=self.createDialog({name:name,width:500,title:self.lang("tablecell"),body:html,beforeRemove:function(){colorBox.unbind()},yesBtn:{name:self.lang("yes"),click:function(){var width=widthBox.val(),height=heightBox.val(),widthType=widthTypeBox.val(),heightType=heightTypeBox.val(),textAlign=(paddingBox.val(),spacingBox.val(),textAlignBox.val()),verticalAlign=verticalAlignBox.val(),border=borderBox.val(),borderColor=K(colorBox[0]).html()||"",bgColor=K(colorBox[1]).html()||"";return/^\d*$/.test(width)?/^\d*$/.test(height)?/^\d*$/.test(border)?(cell.css({width:""!==width?width+widthType:"",height:""!==height?height+heightType:"","background-color":bgColor,"text-align":textAlign,"vertical-align":verticalAlign,"border-width":border,"border-style":""!==border?"solid":"","border-color":borderColor}),self.hideDialog().focus(),self.cmd.range.moveToBookmark(bookmark),self.cmd.select(),self.addBookmark(),void 0):(alert(self.lang("invalidBorder")),borderBox[0].focus(),void 0):(alert(self.lang("invalidHeight")),heightBox[0].focus(),void 0):(alert(self.lang("invalidWidth")),widthBox[0].focus(),void 0)}}}),div=dialog.div,widthBox=K('[name="width"]',div).val(100),heightBox=K('[name="height"]',div),widthTypeBox=K('[name="widthType"]',div),heightTypeBox=K('[name="heightType"]',div),paddingBox=K('[name="padding"]',div).val(2),spacingBox=K('[name="spacing"]',div).val(0),textAlignBox=K('[name="textAlign"]',div),verticalAlignBox=K('[name="verticalAlign"]',div),borderBox=K('[name="border"]',div).val(1),colorBox=K(".ke-input-color",div);_initColorPicker(div,colorBox.eq(0)),_initColorPicker(div,colorBox.eq(1)),_setColor(colorBox.eq(0),"#000000"),_setColor(colorBox.eq(1),""),widthBox[0].focus(),widthBox[0].select();var match,cell=self.plugin.getSelectedCell(),cellWidth=cell[0].style.width||cell[0].width||"",cellHeight=cell[0].style.height||cell[0].height||"";(match=/^(\d+)((?:px|%)*)$/.exec(cellWidth))?(widthBox.val(match[1]),widthTypeBox.val(match[2])):widthBox.val(""),(match=/^(\d+)((?:px|%)*)$/.exec(cellHeight))&&(heightBox.val(match[1]),heightTypeBox.val(match[2])),textAlignBox.val(cell[0].style.textAlign||""),verticalAlignBox.val(cell[0].style.verticalAlign||"");var border=cell[0].style.borderWidth||"";border&&(border=parseInt(border)),borderBox.val(border),_setColor(colorBox.eq(0),K.toHex(cell[0].style.borderColor||"")),_setColor(colorBox.eq(1),K.toHex(cell[0].style.backgroundColor||"")),widthBox[0].focus(),widthBox[0].select()},insert:function(){this.prop(!0)},"delete":function(){var table=self.plugin.getSelectedTable();self.cmd.range.setStartBefore(table[0]).collapse(!0),self.cmd.select(),table.remove(),self.addBookmark()},colinsert:function(offset){var table=self.plugin.getSelectedTable()[0],row=self.plugin.getSelectedRow()[0],cell=self.plugin.getSelectedCell()[0],index=cell.cellIndex+offset;index+=table.rows[0].cells.length-row.cells.length;for(var i=0,len=table.rows.length;len>i;i++){var newRow=table.rows[i],newCell=newRow.insertCell(index);newCell.innerHTML=K.IE?"":"<br />",index=_getCellIndex(table,newRow,newCell)}self.cmd.range.selectNodeContents(cell).collapse(!0),self.cmd.select(),self.addBookmark()},colinsertleft:function(){this.colinsert(0)},colinsertright:function(){this.colinsert(1)},rowinsert:function(offset){var table=self.plugin.getSelectedTable()[0],row=self.plugin.getSelectedRow()[0],cell=self.plugin.getSelectedCell()[0],rowIndex=row.rowIndex;1===offset&&(rowIndex=row.rowIndex+(cell.rowSpan-1)+offset);for(var newRow=table.insertRow(rowIndex),i=0,len=row.cells.length;len>i;i++){row.cells[i].rowSpan>1&&(len-=row.cells[i].rowSpan-1);var newCell=newRow.insertCell(i);1===offset&&row.cells[i].colSpan>1&&(newCell.colSpan=row.cells[i].colSpan),newCell.innerHTML=K.IE?"":"<br />"}for(var j=rowIndex;j>=0;j--){var cells=table.rows[j].cells;if(cells.length>i){for(var k=cell.cellIndex;k>=0;k--)cells[k].rowSpan>1&&(cells[k].rowSpan+=1);break}}self.cmd.range.selectNodeContents(cell).collapse(!0),self.cmd.select(),self.addBookmark()},rowinsertabove:function(){this.rowinsert(0)},rowinsertbelow:function(){this.rowinsert(1)},rowmerge:function(){var table=self.plugin.getSelectedTable()[0],row=self.plugin.getSelectedRow()[0],cell=self.plugin.getSelectedCell()[0],rowIndex=row.rowIndex,nextRowIndex=rowIndex+cell.rowSpan,nextRow=table.rows[nextRowIndex];if(!(table.rows.length<=nextRowIndex)){var cellIndex=cell.cellIndex;if(!(nextRow.cells.length<=cellIndex)){var nextCell=nextRow.cells[cellIndex];cell.colSpan===nextCell.colSpan&&(cell.rowSpan+=nextCell.rowSpan,nextRow.deleteCell(cellIndex),self.cmd.range.selectNodeContents(cell).collapse(!0),self.cmd.select(),self.addBookmark())}}},colmerge:function(){var row=(self.plugin.getSelectedTable()[0],self.plugin.getSelectedRow()[0]),cell=self.plugin.getSelectedCell()[0],cellIndex=(row.rowIndex,cell.cellIndex),nextCellIndex=cellIndex+1;if(!(row.cells.length<=nextCellIndex)){var nextCell=row.cells[nextCellIndex];cell.rowSpan===nextCell.rowSpan&&(cell.colSpan+=nextCell.colSpan,row.deleteCell(nextCellIndex),self.cmd.range.selectNodeContents(cell).collapse(!0),self.cmd.select(),self.addBookmark())}},rowsplit:function(){var table=self.plugin.getSelectedTable()[0],row=self.plugin.getSelectedRow()[0],cell=self.plugin.getSelectedCell()[0],rowIndex=row.rowIndex;if(1!==cell.rowSpan){for(var cellIndex=_getCellIndex(table,row,cell),i=1,len=cell.rowSpan;len>i;i++){var newRow=table.rows[rowIndex+i],newCell=newRow.insertCell(cellIndex);cell.colSpan>1&&(newCell.colSpan=cell.colSpan),newCell.innerHTML=K.IE?"":"<br />",cellIndex=_getCellIndex(table,newRow,newCell)}K(cell).removeAttr("rowSpan"),self.cmd.range.selectNodeContents(cell).collapse(!0),self.cmd.select(),self.addBookmark()}},colsplit:function(){var row=(self.plugin.getSelectedTable()[0],self.plugin.getSelectedRow()[0]),cell=self.plugin.getSelectedCell()[0],cellIndex=cell.cellIndex;if(1!==cell.colSpan){for(var i=1,len=cell.colSpan;len>i;i++){var newCell=row.insertCell(cellIndex+i);cell.rowSpan>1&&(newCell.rowSpan=cell.rowSpan),newCell.innerHTML=K.IE?"":"<br />"}K(cell).removeAttr("colSpan"),self.cmd.range.selectNodeContents(cell).collapse(!0),self.cmd.select(),self.addBookmark()}},coldelete:function(){for(var table=self.plugin.getSelectedTable()[0],row=self.plugin.getSelectedRow()[0],cell=self.plugin.getSelectedCell()[0],index=cell.cellIndex,i=0,len=table.rows.length;len>i;i++){var newRow=table.rows[i],newCell=newRow.cells[index];newCell.colSpan>1?(newCell.colSpan-=1,1===newCell.colSpan&&K(newCell).removeAttr("colSpan")):newRow.deleteCell(index),newCell.rowSpan>1&&(i+=newCell.rowSpan-1)}0===row.cells.length?(self.cmd.range.setStartBefore(table).collapse(!0),self.cmd.select(),K(table).remove()):self.cmd.selection(!0),self.addBookmark()},rowdelete:function(){for(var table=self.plugin.getSelectedTable()[0],row=self.plugin.getSelectedRow()[0],cell=self.plugin.getSelectedCell()[0],rowIndex=row.rowIndex,i=cell.rowSpan-1;i>=0;i--)table.deleteRow(rowIndex+i);0===table.rows.length?(self.cmd.range.setStartBefore(table).collapse(!0),self.cmd.select(),K(table).remove()):self.cmd.selection(!0),self.addBookmark()}},self.clickToolbar(name,self.plugin.table.prop)});