KindEditor.plugin("filemanager",function(K){function makeFileTitle(filename,filesize,datetime){return filename+" ("+Math.ceil(filesize/1024)+"KB, "+datetime+")"}function bindTitle(el,data){data.is_dir?el.attr("title",data.filename):el.attr("title",makeFileTitle(data.filename,data.filesize,data.datetime))}var self=this,name="filemanager",fileManagerJson=K.undef(self.fileManagerJson,self.basePath+"php/file_manager_json.php"),imgPath=self.pluginsPath+name+"/images/",lang=self.lang(name+".");self.plugin.filemanagerDialog=function(options){function reloadPage(path,order,func){var param="path="+path+"&order="+order+"&dir="+dirName;dialog.showLoading(self.lang("ajaxLoading")),K.ajax(K.addParam(fileManagerJson,param+"&"+(new Date).getTime()),function(data){dialog.hideLoading(),func(data)})}function bindEvent(el,result,data,createFunc){var fileUrl=K.formatUrl(result.current_url+data.filename,"absolute"),dirPath=encodeURIComponent(result.current_dir_path+data.filename+"/");data.is_dir?el.click(function(){reloadPage(dirPath,orderTypeBox.val(),createFunc)}):data.is_photo?el.click(function(){clickFn.call(this,fileUrl,data.filename)}):el.click(function(){clickFn.call(this,fileUrl,data.filename)}),elList.push(el)}function createCommon(result,createFunc){function changeFunc(){"VIEW"==viewTypeBox.val()?reloadPage(result.current_dir_path,orderTypeBox.val(),createView):reloadPage(result.current_dir_path,orderTypeBox.val(),createList)}K.each(elList,function(){this.unbind()}),moveupLink.unbind(),viewTypeBox.unbind(),orderTypeBox.unbind(),result.current_dir_path&&moveupLink.click(function(){reloadPage(result.moveup_dir_path,orderTypeBox.val(),createFunc)}),viewTypeBox.change(changeFunc),orderTypeBox.change(changeFunc),bodyDiv.html("")}function createList(result){createCommon(result,createList);var table=document.createElement("table");table.className="ke-table",table.cellPadding=0,table.cellSpacing=0,table.border=0,bodyDiv.append(table);for(var fileList=result.file_list,i=0,len=fileList.length;len>i;i++){var data=fileList[i],row=K(table.insertRow(i));row.mouseover(function(){K(this).addClass("ke-on")}).mouseout(function(){K(this).removeClass("ke-on")});var iconUrl=imgPath+(data.is_dir?"folder-16.gif":"file-16.gif"),img=K('<img src="'+iconUrl+'" width="16" height="16" alt="'+data.filename+'" align="absmiddle" />'),cell0=K(row[0].insertCell(0)).addClass("ke-cell ke-name").append(img).append(document.createTextNode(" "+data.filename));!data.is_dir||data.has_file?(row.css("cursor","pointer"),cell0.attr("title",data.filename),bindEvent(cell0,result,data,createList)):cell0.attr("title",lang.emptyFolder),K(row[0].insertCell(1)).addClass("ke-cell ke-size").html(data.is_dir?"-":Math.ceil(data.filesize/1024)+"KB"),K(row[0].insertCell(2)).addClass("ke-cell ke-datetime").html(data.datetime)}}function createView(result){createCommon(result,createView);for(var fileList=result.file_list,i=0,len=fileList.length;len>i;i++){var data=fileList[i],div=K('<div class="ke-inline-block ke-item"></div>');bodyDiv.append(div);var photoDiv=K('<div class="ke-inline-block ke-photo"></div>').mouseover(function(){K(this).addClass("ke-on")}).mouseout(function(){K(this).removeClass("ke-on")});div.append(photoDiv);var fileUrl=result.current_url+data.filename,iconUrl=data.is_dir?imgPath+"folder-64.gif":data.is_photo?fileUrl:imgPath+"file-64.gif",img=K('<img src="'+iconUrl+'" width="80" height="80" alt="'+data.filename+'" />');!data.is_dir||data.has_file?(photoDiv.css("cursor","pointer"),bindTitle(photoDiv,data),bindEvent(photoDiv,result,data,createView)):photoDiv.attr("title",lang.emptyFolder),photoDiv.append(img),div.append('<div class="ke-name" title="'+data.filename+'">'+data.filename+"</div>")}}var width=K.undef(options.width,650),height=K.undef(options.height,510),dirName=K.undef(options.dirName,""),viewType=K.undef(options.viewType,"VIEW").toUpperCase(),clickFn=options.clickFn,html=['<div style="padding:10px 20px;">','<div class="ke-plugin-filemanager-header">','<div class="ke-left">','<img class="ke-inline-block" name="moveupImg" src="'+imgPath+'go-up.gif" width="16" height="16" border="0" alt="" /> ','<a class="ke-inline-block" name="moveupLink" href="javascript:;">'+lang.moveup+"</a>","</div>",'<div class="ke-right">',lang.viewType+' <select class="ke-inline-block" name="viewType">','<option value="VIEW">'+lang.viewImage+"</option>",'<option value="LIST">'+lang.listImage+"</option>","</select> ",lang.orderType+' <select class="ke-inline-block" name="orderType">','<option value="NAME">'+lang.fileName+"</option>",'<option value="SIZE">'+lang.fileSize+"</option>",'<option value="TYPE">'+lang.fileType+"</option>","</select>","</div>",'<div class="ke-clearfix"></div>',"</div>",'<div class="ke-plugin-filemanager-body"></div>',"</div>"].join(""),dialog=self.createDialog({name:name,width:width,height:height,title:self.lang(name),body:html}),div=dialog.div,bodyDiv=K(".ke-plugin-filemanager-body",div),moveupLink=(K('[name="moveupImg"]',div),K('[name="moveupLink"]',div)),viewTypeBox=(K('[name="viewServer"]',div),K('[name="viewType"]',div)),orderTypeBox=K('[name="orderType"]',div),elList=[];return viewTypeBox.val(viewType),reloadPage("",orderTypeBox.val(),"VIEW"==viewType?createView:createList),dialog}});