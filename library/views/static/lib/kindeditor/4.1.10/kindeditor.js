!function(window,undefined){function _isArray(val){return val?"[object Array]"===Object.prototype.toString.call(val):!1}function _isFunction(val){return val?"[object Function]"===Object.prototype.toString.call(val):!1}function _inArray(val,arr){for(var i=0,len=arr.length;len>i;i++)if(val===arr[i])return i;return-1}function _each(obj,fn){if(_isArray(obj))for(var i=0,len=obj.length;len>i&&fn.call(obj[i],i,obj[i])!==!1;i++);else for(var key in obj)if(obj.hasOwnProperty(key)&&fn.call(obj[key],key,obj[key])===!1)break}function _trim(str){return str.replace(/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"")}function _inString(val,str,delimiter){return delimiter=delimiter===undefined?",":delimiter,(delimiter+str+delimiter).indexOf(delimiter+val+delimiter)>=0}function _addUnit(val,unit){return unit=unit||"px",val&&/^\d+$/.test(val)?val+unit:val}function _removeUnit(val){var match;return val&&(match=/(\d+)/.exec(val))?parseInt(match[1],10):0}function _escape(val){return val.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function _unescape(val){return val.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&amp;/g,"&")}function _toCamel(str){var arr=str.split("-");return str="",_each(arr,function(key,val){str+=key>0?val.charAt(0).toUpperCase()+val.substr(1):val}),str}function _toHex(val){function hex(d){var s=parseInt(d,10).toString(16).toUpperCase();return s.length>1?s:"0"+s}return val.replace(/rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/gi,function($0,$1,$2,$3){return"#"+hex($1)+hex($2)+hex($3)})}function _toMap(val,delimiter){delimiter=delimiter===undefined?",":delimiter;var match,map={},arr=_isArray(val)?val:val.split(delimiter);return _each(arr,function(key,val){if(match=/^(\d+)\.\.(\d+)$/.exec(val))for(var i=parseInt(match[1],10);i<=parseInt(match[2],10);i++)map[i.toString()]=!0;else map[val]=!0}),map}function _toArray(obj,offset){return Array.prototype.slice.call(obj,offset||0)}function _undef(val,defaultVal){return val===undefined?defaultVal:val}function _invalidUrl(url){return!url||/[<>"]/.test(url)}function _addParam(url,param){return url.indexOf("?")>=0?url+"&"+param:url+"?"+param}function _extend(child,parent,proto){proto||(proto=parent,parent=null);var childProto;if(parent){var fn=function(){};fn.prototype=parent.prototype,childProto=new fn,_each(proto,function(key,val){childProto[key]=val})}else childProto=proto;childProto.constructor=child,child.prototype=childProto,child.parent=parent?parent.prototype:null}function _json(text){var match;(match=/\{[\s\S]*\}|\[[\s\S]*\]/.exec(text))&&(text=match[0]);var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g;if(cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})),/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return eval("("+text+")");throw"JSON parse error"}function _getBasePath(){for(var src,els=document.getElementsByTagName("script"),i=0,len=els.length;len>i;i++)if(src=els[i].src||"",/kindeditor[\w\-\.]*\.js/.test(src))return src.substring(0,src.lastIndexOf("/")+1);return""}function _bindEvent(el,type,fn){el.addEventListener?el.addEventListener(type,fn,_useCapture):el.attachEvent&&el.attachEvent("on"+type,fn)}function _unbindEvent(el,type,fn){el.removeEventListener?el.removeEventListener(type,fn,_useCapture):el.detachEvent&&el.detachEvent("on"+type,fn)}function KEvent(el,event){this.init(el,event)}function _getId(el){return el[_eventExpendo]||null}function _setId(el){return el[_eventExpendo]=++_eventId,_eventId}function _removeId(el){try{delete el[_eventExpendo]}catch(e){el.removeAttribute&&el.removeAttribute(_eventExpendo)}}function _bind(el,type,fn){if(type.indexOf(",")>=0)return _each(type.split(","),function(){_bind(el,this,fn)}),void 0;var id=_getId(el);id||(id=_setId(el)),_eventData[id]===undefined&&(_eventData[id]={});var events=_eventData[id][type];events&&events.length>0?_unbindEvent(el,type,events[0]):(_eventData[id][type]=[],_eventData[id].el=el),events=_eventData[id][type],0===events.length&&(events[0]=function(e){var kevent=e?new KEvent(el,e):undefined;_each(events,function(i,event){i>0&&event&&event.call(el,kevent)})}),_inArray(fn,events)<0&&events.push(fn),_bindEvent(el,type,events[0])}function _unbind(el,type,fn){if(type&&type.indexOf(",")>=0)return _each(type.split(","),function(){_unbind(el,this,fn)}),void 0;var id=_getId(el);if(id){if(type===undefined)return id in _eventData&&(_each(_eventData[id],function(key,events){"el"!=key&&events.length>0&&_unbindEvent(el,key,events[0])}),delete _eventData[id],_removeId(el)),void 0;if(_eventData[id]){var events=_eventData[id][type];if(events&&events.length>0){fn===undefined?(_unbindEvent(el,type,events[0]),delete _eventData[id][type]):(_each(events,function(i,event){i>0&&event===fn&&events.splice(i,1)}),1==events.length&&(_unbindEvent(el,type,events[0]),delete _eventData[id][type]));var count=0;_each(_eventData[id],function(){count++}),2>count&&(delete _eventData[id],_removeId(el))}}}}function _fire(el,type){if(type.indexOf(",")>=0)return _each(type.split(","),function(){_fire(el,this)}),void 0;var id=_getId(el);if(id){var events=_eventData[id][type];_eventData[id]&&events&&events.length>0&&events[0]()}}function _ctrl(el,key,fn){key=/^\d{2,}$/.test(key)?key:key.toUpperCase().charCodeAt(0),_bind(el,"keydown",function(e){!e.ctrlKey||e.which!=key||e.shiftKey||e.altKey||(fn.call(el),e.stop())})}function _ready(fn){function readyFunc(){loaded||(loaded=!0,fn(KindEditor),_readyFinished=!0)}function ieReadyFunc(){if(!loaded){try{document.documentElement.doScroll("left")}catch(e){return setTimeout(ieReadyFunc,100),void 0}readyFunc()}}function ieReadyStateFunc(){"complete"===document.readyState&&readyFunc()}if(_readyFinished)return fn(KindEditor),void 0;var loaded=!1;if(document.addEventListener)_bind(document,"DOMContentLoaded",readyFunc);else if(document.attachEvent){_bind(document,"readystatechange",ieReadyStateFunc);var toplevel=!1;try{toplevel=null==window.frameElement}catch(e){}document.documentElement.doScroll&&toplevel&&ieReadyFunc()}_bind(window,"load",readyFunc)}function _getCssList(css){for(var match,list={},reg=/\s*([\w\-]+)\s*:([^;]*)(;|$)/g;match=reg.exec(css);){var key=_trim(match[1].toLowerCase()),val=_trim(_toHex(match[2]));list[key]=val}return list}function _getAttrList(tag){for(var match,list={},reg=/\s+(?:([\w\-:]+)|(?:([\w\-:]+)=([^\s"'<>]+))|(?:([\w\-:"]+)="([^"]*)")|(?:([\w\-:"]+)='([^']*)'))(?=(?:\s|\/|>)+)/g;match=reg.exec(tag);){var key=(match[1]||match[2]||match[4]||match[6]).toLowerCase(),val=(match[2]?match[3]:match[4]?match[5]:match[7])||"";list[key]=val}return list}function _addClassToTag(tag,className){return tag=/\s+class\s*=/.test(tag)?tag.replace(/(\s+class=["']?)([^"']*)(["']?[\s>])/,function($0,$1,$2,$3){return(" "+$2+" ").indexOf(" "+className+" ")<0?""===$2?$1+className+$3:$1+$2+" "+className+$3:$0}):tag.substr(0,tag.length-1)+' class="'+className+'">'}function _formatCss(css){var str="";return _each(_getCssList(css),function(key,val){str+=key+":"+val+";"}),str}function _formatUrl(url,mode,host,pathname){function getRealPath(path){for(var parts=path.split("/"),paths=[],i=0,len=parts.length;len>i;i++){var part=parts[i];".."==part?paths.length>0&&paths.pop():""!==part&&"."!=part&&paths.push(part)}return"/"+paths.join("/")}function getRelativePath(path,depth){if(url.substr(0,path.length)===path){for(var arr=[],i=0;depth>i;i++)arr.push("..");var prefix=".";return arr.length>0&&(prefix+="/"+arr.join("/")),"/"==pathname&&(prefix+="/"),prefix+url.substr(path.length)}return(match=/^(.*)\//.exec(path))?getRelativePath(match[1],++depth):void 0}if(mode=_undef(mode,"").toLowerCase(),"data:"!=url.substr(0,5)&&(url=url.replace(/([^:])\/\//g,"$1/")),_inArray(mode,["absolute","relative","domain"])<0)return url;if(host=host||location.protocol+"//"+location.host,pathname===undefined){var m=location.pathname.match(/^(\/.*)\//);pathname=m?m[1]:""}var match;if(match=/^(\w+:\/\/[^\/]*)/.exec(url)){if(match[1]!==host)return url}else if(/^\w+:/.test(url))return url;return/^\//.test(url)?url=host+getRealPath(url.substr(1)):/^\w+:\/\//.test(url)||(url=host+getRealPath(pathname+"/"+url)),"relative"===mode?url=getRelativePath(host+pathname,0).substr(2):"absolute"===mode&&url.substr(0,host.length)===host&&(url=url.substr(host.length)),url}function _formatHtml(html,htmlTags,urlType,wellFormatted,indentChar){null==html&&(html=""),urlType=urlType||"",wellFormatted=_undef(wellFormatted,!1),indentChar=_undef(indentChar,"	");var fontSizeList="xx-small,x-small,small,medium,large,x-large,xx-large".split(",");html=html.replace(/(<(?:pre|pre\s[^>]*)>)([\s\S]*?)(<\/pre>)/gi,function($0,$1,$2,$3){return $1+$2.replace(/<(?:br|br\s[^>]*)>/gi,"\n")+$3}),html=html.replace(/<(?:br|br\s[^>]*)\s*\/?>\s*<\/p>/gi,"</p>"),html=html.replace(/(<(?:p|p\s[^>]*)>)\s*(<\/p>)/gi,"$1<br />$2"),html=html.replace(/\u200B/g,""),html=html.replace(/\u00A9/g,"&copy;"),html=html.replace(/\u00AE/g,"&reg;"),html=html.replace(/<[^>]+/g,function($0){return $0.replace(/\s+/g," ")});var htmlTagMap={};htmlTags&&(_each(htmlTags,function(key,val){for(var arr=key.split(","),i=0,len=arr.length;len>i;i++)htmlTagMap[arr[i]]=_toMap(val)}),htmlTagMap.script||(html=html.replace(/(<(?:script|script\s[^>]*)>)([\s\S]*?)(<\/script>)/gi,"")),htmlTagMap.style||(html=html.replace(/(<(?:style|style\s[^>]*)>)([\s\S]*?)(<\/style>)/gi,"")));var re=/(\s*)<(\/)?([\w\-:]+)((?:\s+|(?:\s+[\w\-:]+)|(?:\s+[\w\-:]+=[^\s"'<>]+)|(?:\s+[\w\-:"]+="[^"]*")|(?:\s+[\w\-:"]+='[^']*'))*)(\/)?>(\s*)/g,tagStack=[];return html=html.replace(re,function($0,$1,$2,$3,$4,$5,$6){var full=$0,startNewline=$1||"",startSlash=$2||"",tagName=$3.toLowerCase(),attr=$4||"",endSlash=$5?" "+$5:"",endNewline=$6||"";if(htmlTags&&!htmlTagMap[tagName])return"";if(""===endSlash&&_SINGLE_TAG_MAP[tagName]&&(endSlash=" /"),_INLINE_TAG_MAP[tagName]&&(startNewline&&(startNewline=" "),endNewline&&(endNewline=" ")),_PRE_TAG_MAP[tagName]&&(startSlash?endNewline="\n":startNewline="\n"),wellFormatted&&"br"==tagName&&(endNewline="\n"),_BLOCK_TAG_MAP[tagName]&&!_PRE_TAG_MAP[tagName])if(wellFormatted){startSlash&&tagStack.length>0&&tagStack[tagStack.length-1]===tagName?tagStack.pop():tagStack.push(tagName),startNewline="\n",endNewline="\n";for(var i=0,len=startSlash?tagStack.length:tagStack.length-1;len>i;i++)startNewline+=indentChar,startSlash||(endNewline+=indentChar);endSlash?tagStack.pop():startSlash||(endNewline+=indentChar)}else startNewline=endNewline="";if(""!==attr){var attrMap=_getAttrList(full);if("font"===tagName){var fontStyleMap={},fontStyle="";_each(attrMap,function(key,val){"color"===key&&(fontStyleMap.color=val,delete attrMap[key]),"size"===key&&(fontStyleMap["font-size"]=fontSizeList[parseInt(val,10)-1]||"",delete attrMap[key]),"face"===key&&(fontStyleMap["font-family"]=val,delete attrMap[key]),"style"===key&&(fontStyle=val)}),fontStyle&&!/;$/.test(fontStyle)&&(fontStyle+=";"),_each(fontStyleMap,function(key,val){""!==val&&(/\s/.test(val)&&(val="'"+val+"'"),fontStyle+=key+":"+val+";")}),attrMap.style=fontStyle}_each(attrMap,function(key,val){if(_FILL_ATTR_MAP[key]&&(attrMap[key]=key),_inArray(key,["src","href"])>=0&&(attrMap[key]=_formatUrl(val,urlType)),(htmlTags&&"style"!==key&&!htmlTagMap[tagName]["*"]&&!htmlTagMap[tagName][key]||"body"===tagName&&"contenteditable"===key||/^kindeditor_\d+$/.test(key))&&delete attrMap[key],"style"===key&&""!==val){var styleMap=_getCssList(val);_each(styleMap,function(k){!htmlTags||htmlTagMap[tagName].style||htmlTagMap[tagName]["."+k]||delete styleMap[k]});var style="";_each(styleMap,function(k,v){style+=k+":"+v+";"}),attrMap.style=style}}),attr="",_each(attrMap,function(key,val){("style"!==key||""!==val)&&(val=val.replace(/"/g,"&quot;"),attr+=" "+key+'="'+val+'"')})}return"font"===tagName&&(tagName="span"),startNewline+"<"+startSlash+tagName+attr+endSlash+">"+endNewline}),html=html.replace(/(<(?:pre|pre\s[^>]*)>)([\s\S]*?)(<\/pre>)/gi,function($0,$1,$2,$3){return $1+$2.replace(/\n/g,'<span id="__kindeditor_pre_newline__">\n')+$3}),html=html.replace(/\n\s*\n/g,"\n"),html=html.replace(/<span id="__kindeditor_pre_newline__">\n/g,"\n"),_trim(html)}function _clearMsWord(html,htmlTags){return html=html.replace(/<meta[\s\S]*?>/gi,"").replace(/<![\s\S]*?>/gi,"").replace(/<style[^>]*>[\s\S]*?<\/style>/gi,"").replace(/<script[^>]*>[\s\S]*?<\/script>/gi,"").replace(/<w:[^>]+>[\s\S]*?<\/w:[^>]+>/gi,"").replace(/<o:[^>]+>[\s\S]*?<\/o:[^>]+>/gi,"").replace(/<xml>[\s\S]*?<\/xml>/gi,"").replace(/<(?:table|td)[^>]*>/gi,function(full){return full.replace(/border-bottom:([#\w\s]+)/gi,"border:$1")}),_formatHtml(html,htmlTags)}function _mediaType(src){return/\.(rm|rmvb)(\?|$)/i.test(src)?"audio/x-pn-realaudio-plugin":/\.(swf|flv)(\?|$)/i.test(src)?"application/x-shockwave-flash":"video/x-ms-asf-plugin"}function _mediaClass(type){return/realaudio/i.test(type)?"ke-rm":/flash/i.test(type)?"ke-flash":"ke-media"}function _mediaAttrs(srcTag){return _getAttrList(unescape(srcTag))}function _mediaEmbed(attrs){var html="<embed ";return _each(attrs,function(key,val){html+=key+'="'+val+'" '}),html+="/>"}function _mediaImg(blankPath,attrs){var width=attrs.width,height=attrs.height,type=attrs.type||_mediaType(attrs.src),srcTag=_mediaEmbed(attrs),style="";/\D/.test(width)?style+="width:"+width+";":width>0&&(style+="width:"+width+"px;"),/\D/.test(height)?style+="height:"+height+";":height>0&&(style+="height:"+height+"px;");var html='<img class="'+_mediaClass(type)+'" src="'+blankPath+'" ';return""!==style&&(html+='style="'+style+'" '),html+='data-ke-tag="'+escape(srcTag)+'" alt="" />'}function _tmpl(str,data){var fn=new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+str.replace(/[\r\t\n]/g," ").split("<%").join("	").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("	").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');");return data?fn(data):fn}function _contains(nodeA,nodeB){if(9==nodeA.nodeType&&9!=nodeB.nodeType)return!0;for(;nodeB=nodeB.parentNode;)if(nodeB==nodeA)return!0;return!1}function _getAttr(el,key){key=key.toLowerCase();var val=null;if(_GET_SET_ATTRIBUTE||"script"==el.nodeName.toLowerCase())try{val=el.getAttribute(key,2)}catch(e){val=el.getAttribute(key,1)}else{var div=el.ownerDocument.createElement("div");div.appendChild(el.cloneNode(!1));var list=_getAttrList(_unescape(div.innerHTML));key in list&&(val=list[key])}return"style"===key&&null!==val&&(val=_formatCss(val)),val}function _queryAll(expr,root){function escape(str){return"string"!=typeof str?str:str.replace(/([^\w\-])/g,"\\$1")}function stripslashes(str){return str.replace(/\\/g,"")}function cmpTag(tagA,tagB){return"*"===tagA||tagA.toLowerCase()===escape(tagB.toLowerCase())}function byId(id,tag,root){var arr=[],doc=root.ownerDocument||root,el=doc.getElementById(stripslashes(id));return el&&cmpTag(tag,el.nodeName)&&_contains(root,el)&&arr.push(el),arr}function byClass(className,tag,root){var els,i,len,el,doc=root.ownerDocument||root,arr=[];if(root.getElementsByClassName)for(els=root.getElementsByClassName(stripslashes(className)),i=0,len=els.length;len>i;i++)el=els[i],cmpTag(tag,el.nodeName)&&arr.push(el);else if(doc.querySelectorAll)for(els=doc.querySelectorAll(("#document"!==root.nodeName?root.nodeName+" ":"")+tag+"."+className),i=0,len=els.length;len>i;i++)el=els[i],_contains(root,el)&&arr.push(el);else for(els=root.getElementsByTagName(tag),className=" "+className+" ",i=0,len=els.length;len>i;i++)if(el=els[i],1==el.nodeType){var cls=el.className;cls&&(" "+cls+" ").indexOf(className)>-1&&arr.push(el)}return arr}function byName(name,tag,root){for(var el,arr=[],doc=root.ownerDocument||root,els=doc.getElementsByName(stripslashes(name)),i=0,len=els.length;len>i;i++)el=els[i],cmpTag(tag,el.nodeName)&&_contains(root,el)&&null!==el.getAttribute("name")&&arr.push(el);return arr}function byAttr(key,val,tag,root){for(var el,arr=[],els=root.getElementsByTagName(tag),i=0,len=els.length;len>i;i++)el=els[i],1==el.nodeType&&(null===val?null!==_getAttr(el,key)&&arr.push(el):val===escape(_getAttr(el,key))&&arr.push(el));return arr}function select(expr,root){var matches,arr=[];matches=/^((?:\\.|[^.#\s\[<>])+)/.exec(expr);var tag=matches?matches[1]:"*";if(matches=/#((?:[\w\-]|\\.)+)$/.exec(expr))arr=byId(matches[1],tag,root);else if(matches=/\.((?:[\w\-]|\\.)+)$/.exec(expr))arr=byClass(matches[1],tag,root);else if(matches=/\[((?:[\w\-]|\\.)+)\]/.exec(expr))arr=byAttr(matches[1].toLowerCase(),null,tag,root);else if(matches=/\[((?:[\w\-]|\\.)+)\s*=\s*['"]?((?:\\.|[^'"]+)+)['"]?\]/.exec(expr)){var key=matches[1].toLowerCase(),val=matches[2];arr="id"===key?byId(val,tag,root):"class"===key?byClass(val,tag,root):"name"===key?byName(val,tag,root):byAttr(key,val,tag,root)}else for(var el,els=root.getElementsByTagName(tag),i=0,len=els.length;len>i;i++)el=els[i],1==el.nodeType&&arr.push(el);return arr}var exprList=expr.split(",");if(exprList.length>1){var mergedResults=[];return _each(exprList,function(){_each(_queryAll(this,root),function(){_inArray(this,mergedResults)<0&&mergedResults.push(this)})}),mergedResults}root=root||document;for(var arr,parts=[],re=/((?:\\.|[^\s>])+|[\s>])/g;arr=re.exec(expr);)" "!==arr[1]&&parts.push(arr[1]);var results=[];if(1==parts.length)return select(parts[0],root);var part,els,subResults,val,v,i,j,k,len,l,isChild=!1;for(i=0,lenth=parts.length;lenth>i;i++)if(part=parts[i],">"!==part){if(i>0){for(els=[],j=0,len=results.length;len>j;j++)for(val=results[j],subResults=select(part,val),k=0,l=subResults.length;l>k;k++)v=subResults[k],isChild?val===v.parentNode&&els.push(v):els.push(v);results=els}else results=select(part,root);if(0===results.length)return[]}else isChild=!0;return results}function _query(expr,root){var arr=_queryAll(expr,root);return arr.length>0?arr[0]:null}function _get(val){return K(val)[0]}function _getDoc(node){return node?node.ownerDocument||node.document||node:document}function _getWin(node){if(!node)return window;var doc=_getDoc(node);return doc.parentWindow||doc.defaultView}function _setHtml(el,html){if(1==el.nodeType){var doc=_getDoc(el);try{el.innerHTML='<img id="__kindeditor_temp_tag__" width="0" height="0" style="display:none;" />'+html;var temp=doc.getElementById("__kindeditor_temp_tag__");temp.parentNode.removeChild(temp)}catch(e){K(el).empty(),K("@"+html,doc).each(function(){el.appendChild(this)})}}}function _hasClass(el,cls){return _inString(cls,el.className," ")}function _setAttr(el,key,val){_IE&&8>_V&&"class"==key.toLowerCase()&&(key="className"),el.setAttribute(key,""+val)}function _removeAttr(el,key){_IE&&8>_V&&"class"==key.toLowerCase()&&(key="className"),_setAttr(el,key,""),el.removeAttribute(key)}function _getNodeName(node){return node&&node.nodeName?node.nodeName.toLowerCase():""}function _computedCss(el,key){var win=_getWin(el),camelKey=_toCamel(key),val="";if(win.getComputedStyle){var style=win.getComputedStyle(el,null);val=style[camelKey]||style.getPropertyValue(key)||el.style[camelKey]}else el.currentStyle&&(val=el.currentStyle[camelKey]||el.style[camelKey]);return val}function _hasVal(node){return!!_VALUE_TAG_MAP[_getNodeName(node)]}function _docElement(doc){return doc=doc||document,_QUIRKS?doc.body:doc.documentElement}function _docHeight(doc){var el=_docElement(doc);return Math.max(el.scrollHeight,el.clientHeight)}function _docWidth(doc){var el=_docElement(doc);return Math.max(el.scrollWidth,el.clientWidth)}function _getScrollPos(doc){doc=doc||document;var x,y;return _IE||_NEWIE||_OPERA?(x=_docElement(doc).scrollLeft,y=_docElement(doc).scrollTop):(x=_getWin(doc).scrollX,y=_getWin(doc).scrollY),{x:x,y:y}}function KNode(node){this.init(node)}function _updateCollapsed(range){return range.collapsed=range.startContainer===range.endContainer&&range.startOffset===range.endOffset,range}function _copyAndDelete(range,isCopy,isDelete){function splitTextNode(node,startOffset,endOffset){var centerNode,length=node.nodeValue.length;if(isCopy){var cloneNode=node.cloneNode(!0);centerNode=startOffset>0?cloneNode.splitText(startOffset):cloneNode,length>endOffset&&centerNode.splitText(endOffset-startOffset)}if(isDelete){var center=node;if(startOffset>0&&(center=node.splitText(startOffset),range.setStart(node,startOffset)),length>endOffset){var right=center.splitText(endOffset-startOffset);range.setEnd(right,0)}nodeList.push(center)}return centerNode}function removeNodes(){isDelete&&range.up().collapse(!0);for(var i=0,len=nodeList.length;len>i;i++){var node=nodeList[i];node.parentNode&&node.parentNode.removeChild(node)}}function extractNodes(parent,frag){for(var nextNode,node=parent.firstChild;node;){var testRange=new KRange(doc).selectNode(node);if(start=testRange.compareBoundaryPoints(_START_TO_END,range),start>=0&&0>=incStart&&(incStart=testRange.compareBoundaryPoints(_START_TO_START,range)),incStart>=0&&0>=incEnd&&(incEnd=testRange.compareBoundaryPoints(_END_TO_END,range)),incEnd>=0&&0>=end&&(end=testRange.compareBoundaryPoints(_END_TO_START,range)),end>=0)return!1;if(nextNode=node.nextSibling,start>0)if(1==node.nodeType)if(incStart>=0&&0>=incEnd)isCopy&&frag.appendChild(node.cloneNode(!0)),isDelete&&nodeList.push(node);else{var childFlag;if(isCopy&&(childFlag=node.cloneNode(!1),frag.appendChild(childFlag)),extractNodes(node,childFlag)===!1)return!1}else if(3==node.nodeType){var textNode;if(textNode=node==copyRange.startContainer?splitTextNode(node,copyRange.startOffset,node.nodeValue.length):node==copyRange.endContainer?splitTextNode(node,0,copyRange.endOffset):splitTextNode(node,0,node.nodeValue.length),isCopy)try{frag.appendChild(textNode)}catch(e){}}node=nextNode}}var doc=range.doc,nodeList=[],copyRange=range.cloneRange().down(),start=-1,incStart=-1,incEnd=-1,end=-1,ancestor=range.commonAncestor(),frag=doc.createDocumentFragment();if(3==ancestor.nodeType){var textNode=splitTextNode(ancestor,range.startOffset,range.endOffset);return isCopy&&frag.appendChild(textNode),removeNodes(),isCopy?frag:range}extractNodes(ancestor,frag),isDelete&&range.up().collapse(!0);for(var i=0,len=nodeList.length;len>i;i++){var node=nodeList[i];node.parentNode&&node.parentNode.removeChild(node)}return isCopy?frag:range}function _moveToElementText(range,el){for(var node=el;node;){var knode=K(node);if("marquee"==knode.name||"select"==knode.name)return;node=node.parentNode}try{range.moveToElementText(el)}catch(e){}}function _getStartEnd(rng,isStart){var doc=rng.parentElement().ownerDocument,pointRange=rng.duplicate();pointRange.collapse(isStart);var parent=pointRange.parentElement(),nodes=parent.childNodes;if(0===nodes.length)return{node:parent.parentNode,offset:K(parent).index()};var startNode=doc,startPos=0,cmp=-1,testRange=rng.duplicate();_moveToElementText(testRange,parent);for(var i=0,len=nodes.length;len>i;i++){var node=nodes[i];if(cmp=testRange.compareEndPoints("StartToStart",pointRange),0===cmp)return{node:node.parentNode,offset:i};if(1==node.nodeType){var dummy,nodeRange=rng.duplicate(),knode=K(node),newNode=node;knode.isControl()&&(dummy=doc.createElement("span"),knode.after(dummy),newNode=dummy,startPos+=knode.text().replace(/\r\n|\n|\r/g,"").length),_moveToElementText(nodeRange,newNode),testRange.setEndPoint("StartToEnd",nodeRange),cmp>0?startPos+=nodeRange.text.replace(/\r\n|\n|\r/g,"").length:startPos=0,dummy&&K(dummy).remove()}else 3==node.nodeType&&(testRange.moveStart("character",node.nodeValue.length),startPos+=node.nodeValue.length);0>cmp&&(startNode=node)}if(0>cmp&&1==startNode.nodeType)return{node:parent,offset:K(parent.lastChild).index()+1};if(cmp>0)for(;startNode.nextSibling&&1==startNode.nodeType;)startNode=startNode.nextSibling;if(testRange=rng.duplicate(),_moveToElementText(testRange,parent),testRange.setEndPoint("StartToEnd",pointRange),startPos-=testRange.text.replace(/\r\n|\n|\r/g,"").length,cmp>0&&3==startNode.nodeType)for(var prevNode=startNode.previousSibling;prevNode&&3==prevNode.nodeType;)startPos-=prevNode.nodeValue.length,prevNode=prevNode.previousSibling;return{node:startNode,offset:startPos}}function _getEndRange(node,offset){var doc=node.ownerDocument||node,range=doc.body.createTextRange();if(doc==node)return range.collapse(!0),range;if(1==node.nodeType&&node.childNodes.length>0){var isStart,child,children=node.childNodes;if(0===offset?(child=children[0],isStart=!0):(child=children[offset-1],isStart=!1),!child)return range;if("head"===K(child).name)return 1===offset&&(isStart=!0),2===offset&&(isStart=!1),range.collapse(isStart),range;if(1==child.nodeType){var span,kchild=K(child);return kchild.isControl()&&(span=doc.createElement("span"),isStart?kchild.before(span):kchild.after(span),child=span),_moveToElementText(range,child),range.collapse(isStart),span&&K(span).remove(),range}node=child,offset=isStart?0:child.nodeValue.length}var dummy=doc.createElement("span");return K(node).before(dummy),_moveToElementText(range,dummy),range.moveStart("character",offset),K(dummy).remove(),range}function _toRange(rng){function tr2td(start){"tr"==K(start.node).name&&(start.node=start.node.cells[start.offset],start.offset=0)}var doc,range;if(_IERANGE){if(rng.item)return doc=_getDoc(rng.item(0)),range=new KRange(doc),range.selectNode(rng.item(0)),range;doc=rng.parentElement().ownerDocument;var start=_getStartEnd(rng,!0),end=_getStartEnd(rng,!1);return tr2td(start),tr2td(end),range=new KRange(doc),range.setStart(start.node,start.offset),range.setEnd(end.node,end.offset),range}var startContainer=rng.startContainer;return doc=startContainer.ownerDocument||startContainer,range=new KRange(doc),range.setStart(startContainer,rng.startOffset),range.setEnd(rng.endContainer,rng.endOffset),range}function KRange(doc){this.init(doc)}function _range(mixed){return mixed.nodeName?new KRange(mixed):mixed.constructor===KRange?mixed:_toRange(mixed)}function _nativeCommand(doc,key,val){try{doc.execCommand(key,!1,val)}catch(e){}}function _nativeCommandValue(doc,key){var val="";try{val=doc.queryCommandValue(key)}catch(e){}return"string"!=typeof val&&(val=""),val}function _getSel(doc){var win=_getWin(doc);return _IERANGE?doc.selection:win.getSelection()}function _getRng(doc){var rng,sel=_getSel(doc);try{rng=sel.rangeCount>0?sel.getRangeAt(0):sel.createRange()}catch(e){}return!_IERANGE||rng&&(rng.item||rng.parentElement().ownerDocument===doc)?rng:null}function _singleKeyMap(map){var arr,v,newMap={};return _each(map,function(key,val){arr=key.split(",");for(var i=0,len=arr.length;len>i;i++)v=arr[i],newMap[v]=val}),newMap}function _hasAttrOrCss(knode,map){return _hasAttrOrCssByKey(knode,map,"*")||_hasAttrOrCssByKey(knode,map)}function _hasAttrOrCssByKey(knode,map,mapKey){if(mapKey=mapKey||knode.name,1!==knode.type)return!1;var newMap=_singleKeyMap(map);if(!newMap[mapKey])return!1;for(var arr=newMap[mapKey].split(","),i=0,len=arr.length;len>i;i++){var key=arr[i];if("*"===key)return!0;var match=/^(\.?)([^=]+)(?:=([^=]*))?$/.exec(key),method=match[1]?"css":"attr";key=match[2];var val=match[3]||"";if(""===val&&""!==knode[method](key))return!0;if(""!==val&&knode[method](key)===val)return!0}return!1}function _removeAttrOrCss(knode,map){1==knode.type&&(_removeAttrOrCssByKey(knode,map,"*"),_removeAttrOrCssByKey(knode,map))}function _removeAttrOrCssByKey(knode,map,mapKey){if(mapKey=mapKey||knode.name,1===knode.type){var newMap=_singleKeyMap(map);if(newMap[mapKey]){for(var arr=newMap[mapKey].split(","),allFlag=!1,i=0,len=arr.length;len>i;i++){var key=arr[i];if("*"===key){allFlag=!0;break}var match=/^(\.?)([^=]+)(?:=([^=]*))?$/.exec(key);key=match[2],match[1]?(key=_toCamel(key),knode[0].style[key]&&(knode[0].style[key]="")):knode.removeAttr(key)}allFlag&&knode.remove(!0)}}}function _getInnerNode(knode){for(var inner=knode;inner.first();)inner=inner.first();return inner}function _isEmptyNode(knode){return 1!=knode.type||knode.isSingle()?!1:""===knode.html().replace(/<[^>]+>/g,"")}function _mergeWrapper(a,b){a=a.clone(!0);for(var lastA=_getInnerNode(a),childA=a,merged=!1;b;){for(;childA;)childA.name===b.name&&(_mergeAttrs(childA,b.attr(),b.css()),merged=!0),childA=childA.first();merged||lastA.append(b.clone(!1)),merged=!1,b=b.first()}return a}function _wrapNode(knode,wrapper){if(wrapper=wrapper.clone(!0),3==knode.type)return _getInnerNode(wrapper).append(knode.clone(!1)),knode.replaceWith(wrapper),wrapper;for(var child,nodeWrapper=knode;(child=knode.first())&&1==child.children().length;)knode=child;child=knode.first();for(var frag=knode.doc.createDocumentFragment();child;)frag.appendChild(child[0]),child=child.next();return wrapper=_mergeWrapper(nodeWrapper,wrapper),frag.firstChild&&_getInnerNode(wrapper).append(frag),nodeWrapper.replaceWith(wrapper),wrapper}function _mergeAttrs(knode,attrs,styles){_each(attrs,function(key,val){"style"!==key&&knode.attr(key,val)}),_each(styles,function(key,val){knode.css(key,val)})}function _inPreElement(knode){for(;knode&&"body"!=knode.name;){if(_PRE_TAG_MAP[knode.name]||"div"==knode.name&&knode.hasClass("ke-script"))return!0;knode=knode.parent()}return!1}function KCmd(range){this.init(range)}function _cmd(mixed){if(mixed.nodeName){var doc=_getDoc(mixed);mixed=_range(doc).selectNodeContents(doc.body).collapse(!1)}return new KCmd(mixed)}function _drag(options){var moveEl=options.moveEl,moveFn=options.moveFn,clickEl=options.clickEl||moveEl,beforeDrag=options.beforeDrag,iframeFix=options.iframeFix===undefined?!0:options.iframeFix,docs=[document];iframeFix&&K("iframe").each(function(){var src=_formatUrl(this.src||"","absolute");if(!/^https?:\/\//.test(src)){var doc;try{doc=_iframeDoc(this)}catch(e){}if(doc){var pos=K(this).pos();K(doc).data("pos-x",pos.x),K(doc).data("pos-y",pos.y),docs.push(doc)}}}),clickEl.mousedown(function(e){function moveListener(e){e.preventDefault();var kdoc=K(_getDoc(e.target)),diffX=_round((kdoc.data("pos-x")||0)+e.pageX-pageX),diffY=_round((kdoc.data("pos-y")||0)+e.pageY-pageY);moveFn.call(clickEl,x,y,width,height,diffX,diffY)}function selectListener(e){e.preventDefault()}function upListener(e){e.preventDefault(),K(docs).unbind("mousemove",moveListener).unbind("mouseup",upListener).unbind("selectstart",selectListener),self.releaseCapture&&self.releaseCapture()}e.stopPropagation();var self=clickEl.get(),x=_removeUnit(moveEl.css("left")),y=_removeUnit(moveEl.css("top")),width=moveEl.width(),height=moveEl.height(),pageX=e.pageX,pageY=e.pageY;beforeDrag&&beforeDrag(),K(docs).mousemove(moveListener).mouseup(upListener).bind("selectstart",selectListener),self.setCapture&&self.setCapture()})}function KWidget(options){this.init(options)}function _widget(options){return new KWidget(options)}function _iframeDoc(iframe){return iframe=_get(iframe),iframe.contentDocument||iframe.contentWindow.document}function _getInitHtml(themesPath,bodyClass,cssPath,cssData){var arr=[""===_direction?"<html>":'<html dir="'+_direction+'">','<head><meta charset="utf-8" /><title></title>',"<style>","html {margin:0;padding:0;}","body {margin:0;padding:5px;}",'body, td {font:12px/1.5 "sans serif",tahoma,verdana,helvetica;}',"body, p, div {word-wrap: break-word;}","p {margin:5px 0;}","table {border-collapse:collapse;}","img {border:0;}","noscript {display:none;}","table.ke-zeroborder td {border:1px dotted #AAA;}","img.ke-flash {","	border:1px solid #AAA;","	background-image:url("+themesPath+"common/flash.gif);","	background-position:center center;","	background-repeat:no-repeat;","	width:100px;","	height:100px;","}","img.ke-rm {","	border:1px solid #AAA;","	background-image:url("+themesPath+"common/rm.gif);","	background-position:center center;","	background-repeat:no-repeat;","	width:100px;","	height:100px;","}","img.ke-media {","	border:1px solid #AAA;","	background-image:url("+themesPath+"common/media.gif);","	background-position:center center;","	background-repeat:no-repeat;","	width:100px;","	height:100px;","}","img.ke-anchor {","	border:1px dashed #666;","	width:16px;","	height:16px;","}",".ke-script, .ke-noscript, .ke-display-none {","	display:none;","	font-size:0;","	width:0;","	height:0;","}",".ke-pagebreak {","	border:1px dotted #AAA;","	font-size:0;","	height:2px;","}","</style>"];
return _isArray(cssPath)||(cssPath=[cssPath]),_each(cssPath,function(i,path){path&&arr.push('<link href="'+path+'" rel="stylesheet" />')}),cssData&&arr.push("<style>"+cssData+"</style>"),arr.push("</head><body "+(bodyClass?'class="'+bodyClass+'"':"")+"></body></html>"),arr.join("\n")}function _elementVal(knode,val){if(knode.hasVal()){if(val===undefined){var html=knode.val();return html=html.replace(/(<(?:p|p\s[^>]*)>) *(<\/p>)/gi,"")}return knode.val(val)}return knode.html(val)}function KEdit(options){this.init(options)}function _edit(options){return new KEdit(options)}function _selectToolbar(name,fn){var self=this,knode=self.get(name);if(knode){if(knode.hasClass("ke-disabled"))return;fn(knode)}}function KToolbar(options){this.init(options)}function _toolbar(options){return new KToolbar(options)}function KMenu(options){this.init(options)}function _menu(options){return new KMenu(options)}function KColorPicker(options){this.init(options)}function _colorpicker(options){return new KColorPicker(options)}function KUploadButton(options){this.init(options)}function _uploadbutton(options){return new KUploadButton(options)}function _createButton(arg){arg=arg||{};var name=arg.name||"",span=K('<span class="ke-button-common ke-button-outer" title="'+name+'"></span>'),btn=K('<input class="ke-button-common ke-button" type="button" value="'+name+'" />');return arg.click&&btn.click(arg.click),span.append(btn),span}function KDialog(options){this.init(options)}function _dialog(options){return new KDialog(options)}function _tabs(options){var self=_widget(options),remove=self.remove,afterSelect=options.afterSelect,div=self.div,liList=[];div.addClass("ke-tabs").bind("contextmenu,mousedown,mousemove",function(e){e.preventDefault()});var ul=K('<ul class="ke-tabs-ul ke-clearfix"></ul>');return div.append(ul),self.add=function(tab){var li=K('<li class="ke-tabs-li">'+tab.title+"</li>");li.data("tab",tab),liList.push(li),ul.append(li)},self.selectedIndex=0,self.select=function(index){self.selectedIndex=index,_each(liList,function(i,li){li.unbind(),i===index?(li.addClass("ke-tabs-li-selected"),K(li.data("tab").panel).show("")):(li.removeClass("ke-tabs-li-selected").removeClass("ke-tabs-li-on").mouseover(function(){K(this).addClass("ke-tabs-li-on")}).mouseout(function(){K(this).removeClass("ke-tabs-li-on")}).click(function(){self.select(i)}),K(li.data("tab").panel).hide())}),afterSelect&&afterSelect.call(self,index)},self.remove=function(){_each(liList,function(){this.remove()}),ul.remove(),remove.call(self)},self}function _loadScript(url,fn){var head=document.getElementsByTagName("head")[0]||(_QUIRKS?document.body:document.documentElement),script=document.createElement("script");head.appendChild(script),script.src=url,script.charset="utf-8",script.onload=script.onreadystatechange=function(){this.readyState&&"loaded"!==this.readyState||(fn&&fn(),script.onload=script.onreadystatechange=null,head.removeChild(script))}}function _chopQuery(url){var index=url.indexOf("?");return index>0?url.substr(0,index):url}function _loadStyle(url){for(var head=document.getElementsByTagName("head")[0]||(_QUIRKS?document.body:document.documentElement),link=document.createElement("link"),absoluteUrl=_chopQuery(_formatUrl(url,"absolute")),links=K('link[rel="stylesheet"]',head),i=0,len=links.length;len>i;i++)if(_chopQuery(_formatUrl(links[i].href,"absolute"))===absoluteUrl)return;head.appendChild(link),link.href=url,link.rel="stylesheet"}function _ajax(url,fn,method,param,dataType){method=method||"GET",dataType=dataType||"json";var xhr=window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");if(xhr.open(method,url,!0),xhr.onreadystatechange=function(){if(4==xhr.readyState&&200==xhr.status&&fn){var data=_trim(xhr.responseText);"json"==dataType&&(data=_json(data)),fn(data)}},"POST"==method){var params=[];_each(param,function(key,val){params.push(encodeURIComponent(key)+"="+encodeURIComponent(val))});try{xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded")}catch(e){}xhr.send(params.join("&"))}else xhr.send(null)}function _plugin(name,fn){return name===undefined?_plugins:fn?(_plugins[name]=fn,void 0):_plugins[name]}function _parseLangKey(key){var match,ns="core";return(match=/^(\w+)\.(\w+)$/.exec(key))&&(ns=match[1],key=match[2]),{ns:ns,key:key}}function _lang(mixed,langType){if(langType=langType===undefined?K.options.langType:langType,"string"==typeof mixed){if(!_language[langType])return"no language";var pos=mixed.length-1;if("."===mixed.substr(pos))return _language[langType][mixed.substr(0,pos)];var obj=_parseLangKey(mixed);return _language[langType][obj.ns][obj.key]}_each(mixed,function(key,val){var obj=_parseLangKey(key);_language[langType]||(_language[langType]={}),_language[langType][obj.ns]||(_language[langType][obj.ns]={}),_language[langType][obj.ns][obj.key]=val})}function _getImageFromRange(range,fn){if(!range.collapsed){range=range.cloneRange().up();var sc=range.startContainer,so=range.startOffset;if(_WEBKIT||range.isControl()){var img=K(sc.childNodes[so]);if(img&&"img"==img.name)return fn(img)?img:void 0}}}function _bindContextmenuEvent(){var self=this,doc=self.edit.doc;K(doc).contextmenu(function(e){if(self.menu&&self.hideMenu(),!self.useContextmenu)return e.preventDefault(),void 0;if(0!==self._contextmenus.length){var maxWidth=0,items=[];for(_each(self._contextmenus,function(){return"-"==this.title?(items.push(this),void 0):(this.cond&&this.cond()&&(items.push(this),this.width&&this.width>maxWidth&&(maxWidth=this.width)),void 0)});items.length>0&&"-"==items[0].title;)items.shift();for(;items.length>0&&"-"==items[items.length-1].title;)items.pop();var prevItem=null;if(_each(items,function(i){"-"==this.title&&"-"==prevItem.title&&delete items[i],prevItem=this}),items.length>0){e.preventDefault();var pos=K(self.edit.iframe).pos(),menu=_menu({x:pos.x+e.clientX,y:pos.y+e.clientY,width:maxWidth,css:{visibility:"hidden"},shadowMode:self.shadowMode});_each(items,function(){this.title&&menu.addItem(this)});var docEl=_docElement(menu.doc),menuHeight=menu.div.height();e.clientY+menuHeight>=docEl.clientHeight-100&&menu.pos(menu.x,_removeUnit(menu.y)-menuHeight),menu.div.css("visibility","visible"),self.menu=menu}}})}function _bindNewlineEvent(){function getAncestorTagName(range){for(var ancestor=K(range.commonAncestor());ancestor&&(1!=ancestor.type||ancestor.isStyle());)ancestor=ancestor.parent();return ancestor.name}var self=this,doc=self.edit.doc,newlineTag=self.newlineTag;if(!(_IE&&"br"!==newlineTag||_GECKO&&3>_V&&"p"!==newlineTag||_OPERA&&9>_V)){var brSkipTagMap=_toMap("h1,h2,h3,h4,h5,h6,pre,li"),pSkipTagMap=_toMap("p,h1,h2,h3,h4,h5,h6,pre,li,blockquote");K(doc).keydown(function(e){if(!(13!=e.which||e.shiftKey||e.ctrlKey||e.altKey)){self.cmd.selection();var tagName=getAncestorTagName(self.cmd.range);if("marquee"!=tagName&&"select"!=tagName)return"br"!==newlineTag||brSkipTagMap[tagName]?(pSkipTagMap[tagName]||_nativeCommand(doc,"formatblock","<p>"),void 0):(e.preventDefault(),self.insertHtml("<br />"+(_IE&&9>_V?"":"​")),void 0)}}),K(doc).keyup(function(e){if(!(13!=e.which||e.shiftKey||e.ctrlKey||e.altKey)&&"br"!=newlineTag){if(_GECKO){var root=self.cmd.commonAncestor("p"),a=self.cmd.commonAncestor("a");return a&&""==a.text()&&(a.remove(!0),self.cmd.range.selectNodeContents(root[0]).collapse(!0),self.cmd.select()),void 0}self.cmd.selection();var tagName=getAncestorTagName(self.cmd.range);if("marquee"!=tagName&&"select"!=tagName){pSkipTagMap[tagName]||_nativeCommand(doc,"formatblock","<p>");var div=self.cmd.commonAncestor("div");if(div){for(var p=K("<p></p>"),child=div[0].firstChild;child;){var next=child.nextSibling;p.append(child),child=next}div.before(p),div.remove(),self.cmd.range.selectNodeContents(p[0]),self.cmd.select()}}}})}}function _bindTabEvent(){var self=this,doc=self.edit.doc;K(doc).keydown(function(e){if(9==e.which){if(e.preventDefault(),self.afterTab)return self.afterTab.call(self,e),void 0;var cmd=self.cmd,range=cmd.range;range.shrink(),range.collapsed&&1==range.startContainer.nodeType&&(range.insertNode(K("@&nbsp;",doc)[0]),cmd.select()),self.insertHtml("&nbsp;&nbsp;&nbsp;&nbsp;")}})}function _bindFocusEvent(){var self=this;K(self.edit.textarea[0],self.edit.win).focus(function(e){self.afterFocus&&self.afterFocus.call(self,e)}).blur(function(e){self.afterBlur&&self.afterBlur.call(self,e)})}function _removeBookmarkTag(html){return _trim(html.replace(/<span [^>]*id="?__kindeditor_bookmark_\w+_\d+__"?[^>]*><\/span>/gi,""))}function _removeTempTag(html){return html.replace(/<div[^>]+class="?__kindeditor_paste__"?[^>]*>[\s\S]*?<\/div>/gi,"")}function _addBookmarkToStack(stack,bookmark){if(0===stack.length)return stack.push(bookmark),void 0;var prev=stack[stack.length-1];_removeBookmarkTag(bookmark.html)!==_removeBookmarkTag(prev.html)&&stack.push(bookmark)}function _undoToRedo(fromStack,toStack){var range,bookmark,self=this,edit=self.edit,body=edit.doc.body;if(0===fromStack.length)return self;edit.designMode?(range=self.cmd.range,bookmark=range.createBookmark(!0),bookmark.html=body.innerHTML):bookmark={html:body.innerHTML},_addBookmarkToStack(toStack,bookmark);var prev=fromStack.pop();return _removeBookmarkTag(bookmark.html)===_removeBookmarkTag(prev.html)&&fromStack.length>0&&(prev=fromStack.pop()),edit.designMode?(edit.html(prev.html),prev.start&&(range.moveToBookmark(prev),self.select())):K(body).html(_removeBookmarkTag(prev.html)),self}function KEditor(options){function setOption(key,val){KEditor.prototype[key]===undefined&&(self[key]=val),self.options[key]=val}var self=this;self.options={},_each(options,function(key){setOption(key,options[key])}),_each(K.options,function(key,val){self[key]===undefined&&setOption(key,val)});var se=K(self.srcElement||"<textarea/>");self.width||(self.width=se[0].style.width||se.width()),self.height||(self.height=se[0].style.height||se.height()),setOption("width",_undef(self.width,self.minWidth)),setOption("height",_undef(self.height,self.minHeight)),setOption("width",_addUnit(self.width)),setOption("height",_addUnit(self.height)),_MOBILE&&(!_IOS||534>_V)&&(self.designMode=!1),self.srcElement=se,self.initContent="",self.plugin={},self.isCreated=!1,self._handlers={},self._contextmenus=[],self._undoStack=[],self._redoStack=[],self._firstAddBookmark=!0,self.menu=self.contextmenu=null,self.dialogs=[]}function _editor(options){return new KEditor(options)}function _create(expr,options){function create(editor){return _each(_plugins,function(name,fn){_isFunction(fn)&&fn.call(editor,KindEditor)}),editor.create()}if(options=options||{},options.basePath=_undef(options.basePath,K.basePath),options.themesPath=_undef(options.themesPath,options.basePath+"themes/"),options.langPath=_undef(options.langPath,options.basePath+"lang/"),options.pluginsPath=_undef(options.pluginsPath,options.basePath+"plugins/"),_undef(options.loadStyleMode,K.options.loadStyleMode)){var themeType=_undef(options.themeType,K.options.themeType);_loadStyle(options.themesPath+"default/default.css"),_loadStyle(options.themesPath+themeType+"/"+themeType+".css")}var knode=K(expr);if(knode&&0!==knode.length){if(knode.length>1)return knode.each(function(){_create(this,options)}),_instances[0];options.srcElement=knode[0];var editor=new KEditor(options);return _instances.push(editor),_language[editor.langType]?create(editor):(_loadScript(editor.langPath+editor.langType+".js?ver="+encodeURIComponent(K.DEBUG?_TIME:_VERSION),function(){create(editor)}),editor)}}function _eachEditor(expr,fn){K(expr).each(function(i,el){K.each(_instances,function(j,editor){return editor&&editor.srcElement[0]==el?(fn.call(editor,j),!1):void 0})})}if(!window.KindEditor){window.console||(window.console={}),console.log||(console.log=function(){});var _VERSION="4.1.10 (2013-11-23)",_ua=navigator.userAgent.toLowerCase(),_IE=_ua.indexOf("msie")>-1&&-1==_ua.indexOf("opera"),_NEWIE=-1==_ua.indexOf("msie")&&_ua.indexOf("trident")>-1,_GECKO=_ua.indexOf("gecko")>-1&&-1==_ua.indexOf("khtml"),_WEBKIT=_ua.indexOf("applewebkit")>-1,_OPERA=_ua.indexOf("opera")>-1,_MOBILE=_ua.indexOf("mobile")>-1,_IOS=/ipad|iphone|ipod/.test(_ua),_QUIRKS="CSS1Compat"!=document.compatMode,_IERANGE=!window.getSelection,_matches=/(?:msie|firefox|webkit|opera)[\/:\s](\d+)/.exec(_ua),_V=_matches?_matches[1]:"0",_TIME=(new Date).getTime(),_round=Math.round,K={DEBUG:!1,VERSION:_VERSION,IE:_IE,GECKO:_GECKO,WEBKIT:_WEBKIT,OPERA:_OPERA,V:_V,TIME:_TIME,each:_each,isArray:_isArray,isFunction:_isFunction,inArray:_inArray,inString:_inString,trim:_trim,addUnit:_addUnit,removeUnit:_removeUnit,escape:_escape,unescape:_unescape,toCamel:_toCamel,toHex:_toHex,toMap:_toMap,toArray:_toArray,undef:_undef,invalidUrl:_invalidUrl,addParam:_addParam,extend:_extend,json:_json},_INLINE_TAG_MAP=_toMap("a,abbr,acronym,b,basefont,bdo,big,br,button,cite,code,del,dfn,em,font,i,img,input,ins,kbd,label,map,q,s,samp,select,small,span,strike,strong,sub,sup,textarea,tt,u,var"),_BLOCK_TAG_MAP=_toMap("address,applet,blockquote,body,center,dd,dir,div,dl,dt,fieldset,form,frameset,h1,h2,h3,h4,h5,h6,head,hr,html,iframe,ins,isindex,li,map,menu,meta,noframes,noscript,object,ol,p,pre,script,style,table,tbody,td,tfoot,th,thead,title,tr,ul"),_SINGLE_TAG_MAP=_toMap("area,base,basefont,br,col,frame,hr,img,input,isindex,link,meta,param,embed"),_STYLE_TAG_MAP=_toMap("b,basefont,big,del,em,font,i,s,small,span,strike,strong,sub,sup,u"),_CONTROL_TAG_MAP=_toMap("img,table,input,textarea,button"),_PRE_TAG_MAP=_toMap("pre,style,script"),_NOSPLIT_TAG_MAP=_toMap("html,head,body,td,tr,table,ol,ul,li"),_AUTOCLOSE_TAG_MAP=_toMap("colgroup,dd,dt,li,options,p,td,tfoot,th,thead,tr"),_FILL_ATTR_MAP=_toMap("checked,compact,declare,defer,disabled,ismap,multiple,nohref,noresize,noshade,nowrap,readonly,selected"),_VALUE_TAG_MAP=_toMap("input,button,textarea,select");K.basePath=_getBasePath(),K.options={designMode:!0,fullscreenMode:!1,filterMode:!0,wellFormatMode:!0,shadowMode:!0,loadStyleMode:!0,basePath:K.basePath,themesPath:K.basePath+"themes/",langPath:K.basePath+"lang/",pluginsPath:K.basePath+"plugins/",themeType:"default",langType:"zh_CN",urlType:"",newlineTag:"p",resizeType:2,syncType:"form",pasteType:2,dialogAlignType:"page",useContextmenu:!0,fullscreenShortcut:!1,bodyClass:"ke-content",indentChar:"	",cssPath:"",cssData:"",minWidth:650,minHeight:100,minChangeSize:50,zIndex:811213,items:["source","|","undo","redo","|","preview","print","template","code","cut","copy","paste","plainpaste","wordpaste","|","justifyleft","justifycenter","justifyright","justifyfull","insertorderedlist","insertunorderedlist","indent","outdent","subscript","superscript","clearhtml","quickformat","selectall","|","fullscreen","/","formatblock","fontname","fontsize","|","forecolor","hilitecolor","bold","italic","underline","strikethrough","lineheight","removeformat","|","image","multiimage","flash","media","insertfile","table","hr","emoticons","baidumap","pagebreak","anchor","link","unlink","|","about"],noDisableItems:["source","fullscreen"],colorTable:[["#E53333","#E56600","#FF9900","#64451D","#DFC5A4","#FFE500"],["#009900","#006600","#99BB00","#B8D100","#60D978","#00D5FF"],["#337FE5","#003399","#4C33E5","#9933E5","#CC33E5","#EE33EE"],["#FFFFFF","#CCCCCC","#999999","#666666","#333333","#000000"]],fontSizeTable:["9px","10px","12px","14px","16px","18px","24px","32px"],htmlTags:{font:["id","class","color","size","face",".background-color"],span:["id","class",".color",".background-color",".font-size",".font-family",".background",".font-weight",".font-style",".text-decoration",".vertical-align",".line-height"],div:["id","class","align",".border",".margin",".padding",".text-align",".color",".background-color",".font-size",".font-family",".font-weight",".background",".font-style",".text-decoration",".vertical-align",".margin-left"],table:["id","class","border","cellspacing","cellpadding","width","height","align","bordercolor",".padding",".margin",".border","bgcolor",".text-align",".color",".background-color",".font-size",".font-family",".font-weight",".font-style",".text-decoration",".background",".width",".height",".border-collapse"],"td,th":["id","class","align","valign","width","height","colspan","rowspan","bgcolor",".text-align",".color",".background-color",".font-size",".font-family",".font-weight",".font-style",".text-decoration",".vertical-align",".background",".border"],a:["id","class","href","target","name"],embed:["id","class","src","width","height","type","loop","autostart","quality",".width",".height","align","allowscriptaccess"],img:["id","class","src","width","height","border","alt","title","align",".width",".height",".border"],"p,ol,ul,li,blockquote,h1,h2,h3,h4,h5,h6":["id","class","align",".text-align",".color",".background-color",".font-size",".font-family",".background",".font-weight",".font-style",".text-decoration",".vertical-align",".text-indent",".margin-left"],pre:["id","class"],hr:["id","class",".page-break-after"],"br,tbody,tr,strong,b,sub,sup,em,i,u,strike,s,del":["id","class"],iframe:["id","class","src","frameborder","width","height",".width",".height"]},layout:'<div class="container"><div class="toolbar"></div><div class="edit"></div><div class="statusbar"></div></div>'};var _useCapture=!1,_INPUT_KEY_MAP=_toMap("8,9,13,32,46,48..57,59,61,65..90,106,109..111,188,190..192,219..222"),_CURSORMOVE_KEY_MAP=_toMap("33..40"),_CHANGE_KEY_MAP={};_each(_INPUT_KEY_MAP,function(key,val){_CHANGE_KEY_MAP[key]=val}),_each(_CURSORMOVE_KEY_MAP,function(key,val){_CHANGE_KEY_MAP[key]=val});var _EVENT_PROPS="altKey,attrChange,attrName,bubbles,button,cancelable,charCode,clientX,clientY,ctrlKey,currentTarget,data,detail,eventPhase,fromElement,handler,keyCode,metaKey,newValue,offsetX,offsetY,originalTarget,pageX,pageY,prevValue,relatedNode,relatedTarget,screenX,screenY,shiftKey,srcElement,target,toElement,view,wheelDelta,which".split(",");_extend(KEvent,{init:function(el,event){var self=this,doc=el.ownerDocument||el.document||el;if(self.event=event,_each(_EVENT_PROPS,function(key,val){self[val]=event[val]}),self.target||(self.target=self.srcElement||doc),3===self.target.nodeType&&(self.target=self.target.parentNode),!self.relatedTarget&&self.fromElement&&(self.relatedTarget=self.fromElement===self.target?self.toElement:self.fromElement),null==self.pageX&&null!=self.clientX){var d=doc.documentElement,body=doc.body;self.pageX=self.clientX+(d&&d.scrollLeft||body&&body.scrollLeft||0)-(d&&d.clientLeft||body&&body.clientLeft||0),self.pageY=self.clientY+(d&&d.scrollTop||body&&body.scrollTop||0)-(d&&d.clientTop||body&&body.clientTop||0)}switch(!self.which&&(self.charCode||0===self.charCode?self.charCode:self.keyCode)&&(self.which=self.charCode||self.keyCode),!self.metaKey&&self.ctrlKey&&(self.metaKey=self.ctrlKey),self.which||self.button===undefined||(self.which=1&self.button?1:2&self.button?3:4&self.button?2:0),self.which){case 186:self.which=59;break;case 187:case 107:case 43:self.which=61;break;case 189:case 45:self.which=109;break;case 42:self.which=106;break;case 47:self.which=111;break;case 78:self.which=110}self.which>=96&&self.which<=105&&(self.which-=48)},preventDefault:function(){var ev=this.event;ev.preventDefault?ev.preventDefault():ev.returnValue=!1},stopPropagation:function(){var ev=this.event;ev.stopPropagation?ev.stopPropagation():ev.cancelBubble=!0},stop:function(){this.preventDefault(),this.stopPropagation()}});var _eventExpendo="kindeditor_"+_TIME,_eventId=0,_eventData={},_readyFinished=!1;_IE&&window.attachEvent("onunload",function(){_each(_eventData,function(key,events){events.el&&_unbind(events.el)})}),K.ctrl=_ctrl,K.ready=_ready,K.formatUrl=_formatUrl,K.formatHtml=_formatHtml,K.getCssList=_getCssList,K.getAttrList=_getAttrList,K.mediaType=_mediaType,K.mediaAttrs=_mediaAttrs,K.mediaEmbed=_mediaEmbed,K.mediaImg=_mediaImg,K.clearMsWord=_clearMsWord,K.tmpl=_tmpl;var _getSetAttrDiv=document.createElement("div");_getSetAttrDiv.setAttribute("className","t");var _GET_SET_ATTRIBUTE="t"!==_getSetAttrDiv.className;K.query=_query,K.queryAll=_queryAll,_extend(KNode,{init:function(node){var self=this;node=_isArray(node)?node:[node];for(var length=0,i=0,len=node.length;len>i;i++)node[i]&&(self[i]=node[i].constructor===KNode?node[i][0]:node[i],length++);self.length=length,self.doc=_getDoc(self[0]),self.name=_getNodeName(self[0]),self.type=self.length>0?self[0].nodeType:null,self.win=_getWin(self[0])},each:function(fn){for(var self=this,i=0;i<self.length;i++)if(fn.call(self[i],i,self[i])===!1)return self;return self},bind:function(type,fn){return this.each(function(){_bind(this,type,fn)}),this},unbind:function(type,fn){return this.each(function(){_unbind(this,type,fn)}),this},fire:function(type){return this.length<1?this:(_fire(this[0],type),this)},hasAttr:function(key){return this.length<1?!1:!!_getAttr(this[0],key)},attr:function(key,val){var self=this;return key===undefined?_getAttrList(self.outer()):"object"==typeof key?(_each(key,function(k,v){self.attr(k,v)}),self):val===undefined?(val=self.length<1?null:_getAttr(self[0],key),null===val?"":val):(self.each(function(){_setAttr(this,key,val)}),self)},removeAttr:function(key){return this.each(function(){_removeAttr(this,key)}),this},get:function(i){return this.length<1?null:this[i||0]},eq:function(i){return this.length<1?null:this[i]?new KNode(this[i]):null},hasClass:function(cls){return this.length<1?!1:_hasClass(this[0],cls)},addClass:function(cls){return this.each(function(){_hasClass(this,cls)||(this.className=_trim(this.className+" "+cls))}),this},removeClass:function(cls){return this.each(function(){_hasClass(this,cls)&&(this.className=_trim(this.className.replace(new RegExp("(^|\\s)"+cls+"(\\s|$)")," ")))}),this},html:function(val){var self=this;return val===undefined?self.length<1||1!=self.type?"":_formatHtml(self[0].innerHTML):(self.each(function(){_setHtml(this,val)}),self)},text:function(){var self=this;return self.length<1?"":_IE?self[0].innerText:self[0].textContent},hasVal:function(){return this.length<1?!1:_hasVal(this[0])},val:function(val){var self=this;return val===undefined?self.length<1?"":self.hasVal()?self[0].value:self.attr("value"):(self.each(function(){_hasVal(this)?this.value=val:_setAttr(this,"value",val)}),self)},css:function(key,val){var self=this;return key===undefined?_getCssList(self.attr("style")):"object"==typeof key?(_each(key,function(k,v){self.css(k,v)}),self):val===undefined?self.length<1?"":self[0].style[_toCamel(key)]||_computedCss(self[0],key)||"":(self.each(function(){this.style[_toCamel(key)]=val}),self)},width:function(val){var self=this;return val===undefined?self.length<1?0:self[0].offsetWidth:self.css("width",_addUnit(val))},height:function(val){var self=this;return val===undefined?self.length<1?0:self[0].offsetHeight:self.css("height",_addUnit(val))},opacity:function(val){return this.each(function(){this.style.opacity===undefined?this.style.filter=1==val?"":"alpha(opacity="+100*val+")":this.style.opacity=1==val?"":val}),this},data:function(key,val){var self=this;return key="kindeditor_data_"+key,val===undefined?self.length<1?null:self[0][key]:(this.each(function(){this[key]=val}),self)},pos:function(){var self=this,node=self[0],x=0,y=0;if(node)if(node.getBoundingClientRect){var box=node.getBoundingClientRect(),pos=_getScrollPos(self.doc);x=box.left+pos.x,y=box.top+pos.y}else for(;node;)x+=node.offsetLeft,y+=node.offsetTop,node=node.offsetParent;return{x:_round(x),y:_round(y)}},clone:function(bool){return this.length<1?new KNode([]):new KNode(this[0].cloneNode(bool))},append:function(expr){return this.each(function(){this.appendChild&&this.appendChild(_get(expr))}),this},appendTo:function(expr){return this.each(function(){_get(expr).appendChild(this)}),this},before:function(expr){return this.each(function(){this.parentNode.insertBefore(_get(expr),this)}),this},after:function(expr){return this.each(function(){this.nextSibling?this.parentNode.insertBefore(_get(expr),this.nextSibling):this.parentNode.appendChild(_get(expr))}),this},replaceWith:function(expr){var nodes=[];return this.each(function(i,node){_unbind(node);var newNode=_get(expr);node.parentNode.replaceChild(newNode,node),nodes.push(newNode)}),K(nodes)},empty:function(){var self=this;return self.each(function(i,node){for(var child=node.firstChild;child;){if(!node.parentNode)return;var next=child.nextSibling;child.parentNode.removeChild(child),child=next}}),self},remove:function(keepChilds){var self=this;return self.each(function(i,node){if(node.parentNode){if(_unbind(node),keepChilds)for(var child=node.firstChild;child;){var next=child.nextSibling;node.parentNode.insertBefore(child,node),child=next}node.parentNode.removeChild(node),delete self[i]}}),self.length=0,self},show:function(val){var self=this;return val===undefined&&(val=self._originDisplay||""),"none"!=self.css("display")?self:self.css("display",val)},hide:function(){var self=this;return self.length<1?self:(self._originDisplay=self[0].style.display,self.css("display","none"))},outer:function(){var self=this;if(self.length<1)return"";var html,div=self.doc.createElement("div");return div.appendChild(self[0].cloneNode(!0)),html=_formatHtml(div.innerHTML),div=null,html},isSingle:function(){return!!_SINGLE_TAG_MAP[this.name]},isInline:function(){return!!_INLINE_TAG_MAP[this.name]},isBlock:function(){return!!_BLOCK_TAG_MAP[this.name]},isStyle:function(){return!!_STYLE_TAG_MAP[this.name]},isControl:function(){return!!_CONTROL_TAG_MAP[this.name]},contains:function(otherNode){return this.length<1?!1:_contains(this[0],_get(otherNode))},parent:function(){if(this.length<1)return null;var node=this[0].parentNode;return node?new KNode(node):null},children:function(){if(this.length<1)return new KNode([]);for(var list=[],child=this[0].firstChild;child;)(3!=child.nodeType||""!==_trim(child.nodeValue))&&list.push(child),child=child.nextSibling;return new KNode(list)},first:function(){var list=this.children();return list.length>0?list.eq(0):null},last:function(){var list=this.children();return list.length>0?list.eq(list.length-1):null},index:function(){if(this.length<1)return-1;for(var i=-1,sibling=this[0];sibling;)i++,sibling=sibling.previousSibling;return i},prev:function(){if(this.length<1)return null;var node=this[0].previousSibling;return node?new KNode(node):null},next:function(){if(this.length<1)return null;var node=this[0].nextSibling;return node?new KNode(node):null},scan:function(fn,order){function walk(node){for(var n=order?node.firstChild:node.lastChild;n;){var next=order?n.nextSibling:n.previousSibling;if(fn(n)===!1)return!1;if(walk(n)===!1)return!1;n=next}}if(!(this.length<1))return order=order===undefined?!0:order,walk(this[0]),this}}),_each("blur,focus,focusin,focusout,load,resize,scroll,unload,click,dblclick,mousedown,mouseup,mousemove,mouseover,mouseout,mouseenter,mouseleave,change,select,submit,keydown,keypress,keyup,error,contextmenu".split(","),function(i,type){KNode.prototype[type]=function(fn){return fn?this.bind(type,fn):this.fire(type)}});var _K=K;K=function(expr,root){function newNode(node){return node[0]||(node=[]),new KNode(node)}if(expr!==undefined&&null!==expr){if("string"==typeof expr){root&&(root=_get(root));var length=expr.length;if("@"===expr.charAt(0)&&(expr=expr.substr(1)),expr.length!==length||/<.+>/.test(expr)){var doc=root?root.ownerDocument||root:document,div=doc.createElement("div"),list=[];div.innerHTML='<img id="__kindeditor_temp_tag__" width="0" height="0" style="display:none;" />'+expr;for(var i=0,len=div.childNodes.length;len>i;i++){var child=div.childNodes[i];"__kindeditor_temp_tag__"!=child.id&&list.push(child)}return newNode(list)}return newNode(_queryAll(expr,root))}return expr&&expr.constructor===KNode?expr:(expr.toArray&&(expr=expr.toArray()),_isArray(expr)?newNode(expr):newNode(_toArray(arguments)))}},_each(_K,function(key,val){K[key]=val}),K.NodeClass=KNode,window.KindEditor=K;var _START_TO_START=0,_START_TO_END=1,_END_TO_END=2,_END_TO_START=3,_BOOKMARK_ID=0;_extend(KRange,{init:function(doc){var self=this;self.startContainer=doc,self.startOffset=0,self.endContainer=doc,self.endOffset=0,self.collapsed=!0,self.doc=doc},commonAncestor:function(){function getParents(node){for(var parents=[];node;)parents.push(node),node=node.parentNode;return parents}for(var parentA,parentB,parentsA=getParents(this.startContainer),parentsB=getParents(this.endContainer),i=0,lenA=parentsA.length,lenB=parentsB.length;++i&&(parentA=parentsA[lenA-i],parentB=parentsB[lenB-i],parentA&&parentB&&parentA===parentB););return parentsA[lenA-i+1]},setStart:function(node,offset){var self=this,doc=self.doc;return self.startContainer=node,self.startOffset=offset,self.endContainer===doc&&(self.endContainer=node,self.endOffset=offset),_updateCollapsed(this)},setEnd:function(node,offset){var self=this,doc=self.doc;return self.endContainer=node,self.endOffset=offset,self.startContainer===doc&&(self.startContainer=node,self.startOffset=offset),_updateCollapsed(this)},setStartBefore:function(node){return this.setStart(node.parentNode||this.doc,K(node).index())},setStartAfter:function(node){return this.setStart(node.parentNode||this.doc,K(node).index()+1)},setEndBefore:function(node){return this.setEnd(node.parentNode||this.doc,K(node).index())},setEndAfter:function(node){return this.setEnd(node.parentNode||this.doc,K(node).index()+1)},selectNode:function(node){return this.setStartBefore(node).setEndAfter(node)},selectNodeContents:function(node){var knode=K(node);if(3==knode.type||knode.isSingle())return this.selectNode(node);var children=knode.children();return children.length>0?this.setStartBefore(children[0]).setEndAfter(children[children.length-1]):this.setStart(node,0).setEnd(node,0)},collapse:function(toStart){return toStart?this.setEnd(this.startContainer,this.startOffset):this.setStart(this.endContainer,this.endOffset)},compareBoundaryPoints:function(how,range){var rangeA=this.get(),rangeB=range.get();if(!_IERANGE)return rangeA.compareBoundaryPoints(how,rangeB);var arr={};arr[_START_TO_START]="StartToStart",arr[_START_TO_END]="EndToStart",arr[_END_TO_END]="EndToEnd",arr[_END_TO_START]="StartToEnd";var cmp=rangeA.compareEndPoints(arr[how],rangeB);if(0!==cmp)return cmp;var nodeA,nodeB,nodeC,posA,posB;if((how===_START_TO_START||how===_END_TO_START)&&(nodeA=this.startContainer,posA=this.startOffset),(how===_START_TO_END||how===_END_TO_END)&&(nodeA=this.endContainer,posA=this.endOffset),(how===_START_TO_START||how===_START_TO_END)&&(nodeB=range.startContainer,posB=range.startOffset),(how===_END_TO_END||how===_END_TO_START)&&(nodeB=range.endContainer,posB=range.endOffset),nodeA===nodeB){var diff=posA-posB;return diff>0?1:0>diff?-1:0}for(nodeC=nodeB;nodeC&&nodeC.parentNode!==nodeA;)nodeC=nodeC.parentNode;if(nodeC)return K(nodeC).index()>=posA?-1:1;for(nodeC=nodeA;nodeC&&nodeC.parentNode!==nodeB;)nodeC=nodeC.parentNode;return nodeC?K(nodeC).index()>=posB?1:-1:(nodeC=K(nodeB).next(),nodeC&&nodeC.contains(nodeA)?1:(nodeC=K(nodeA).next(),nodeC&&nodeC.contains(nodeB)?-1:void 0))},cloneRange:function(){return new KRange(this.doc).setStart(this.startContainer,this.startOffset).setEnd(this.endContainer,this.endOffset)},toString:function(){var rng=this.get(),str=_IERANGE?rng.text:rng.toString();return str.replace(/\r\n|\n|\r/g,"")},cloneContents:function(){return _copyAndDelete(this,!0,!1)},deleteContents:function(){return _copyAndDelete(this,!1,!0)},extractContents:function(){return _copyAndDelete(this,!0,!0)},insertNode:function(node){var firstChild,lastChild,c,self=this,sc=self.startContainer,so=self.startOffset,ec=self.endContainer,eo=self.endOffset,nodeCount=1;return"#document-fragment"===node.nodeName.toLowerCase()&&(firstChild=node.firstChild,lastChild=node.lastChild,nodeCount=node.childNodes.length),1==sc.nodeType?(c=sc.childNodes[so],c?(sc.insertBefore(node,c),sc===ec&&(eo+=nodeCount)):sc.appendChild(node)):3==sc.nodeType&&(0===so?(sc.parentNode.insertBefore(node,sc),sc.parentNode===ec&&(eo+=nodeCount)):so>=sc.nodeValue.length?sc.nextSibling?sc.parentNode.insertBefore(node,sc.nextSibling):sc.parentNode.appendChild(node):(c=so>0?sc.splitText(so):sc,sc.parentNode.insertBefore(node,c),sc===ec&&(ec=c,eo-=so))),firstChild?self.setStartBefore(firstChild).setEndAfter(lastChild):self.selectNode(node),self.compareBoundaryPoints(_END_TO_END,self.cloneRange().setEnd(ec,eo))>=1?self:self.setEnd(ec,eo)
},surroundContents:function(node){return node.appendChild(this.extractContents()),this.insertNode(node).selectNode(node)},isControl:function(){var self=this,sc=self.startContainer,so=self.startOffset,ec=self.endContainer,eo=self.endOffset;return 1==sc.nodeType&&sc===ec&&so+1===eo&&K(sc.childNodes[so]).isControl()},get:function(hasControlRange){var rng,self=this,doc=self.doc;if(!_IERANGE){rng=doc.createRange();try{rng.setStart(self.startContainer,self.startOffset),rng.setEnd(self.endContainer,self.endOffset)}catch(e){}return rng}if(hasControlRange&&self.isControl())return rng=doc.body.createControlRange(),rng.addElement(self.startContainer.childNodes[self.startOffset]),rng;var range=self.cloneRange().down();return rng=doc.body.createTextRange(),rng.setEndPoint("StartToStart",_getEndRange(range.startContainer,range.startOffset)),rng.setEndPoint("EndToStart",_getEndRange(range.endContainer,range.endOffset)),rng},html:function(){return K(this.cloneContents()).outer()},down:function(){function downPos(node,pos,isStart){if(1==node.nodeType){var children=K(node).children();if(0!==children.length){var left,right,child,offset;pos>0&&(left=children.eq(pos-1)),pos<children.length&&(right=children.eq(pos)),left&&3==left.type&&(child=left[0],offset=child.nodeValue.length),right&&3==right.type&&(child=right[0],offset=0),child&&(isStart?self.setStart(child,offset):self.setEnd(child,offset))}}}var self=this;return downPos(self.startContainer,self.startOffset,!0),downPos(self.endContainer,self.endOffset,!1),self},up:function(){function upPos(node,pos,isStart){3==node.nodeType&&(0===pos?isStart?self.setStartBefore(node):self.setEndBefore(node):pos==node.nodeValue.length&&(isStart?self.setStartAfter(node):self.setEndAfter(node)))}var self=this;return upPos(self.startContainer,self.startOffset,!0),upPos(self.endContainer,self.endOffset,!1),self},enlarge:function(toBlock){function enlargePos(node,pos,isStart){var parent,knode=K(node);if(!(3==knode.type||_NOSPLIT_TAG_MAP[knode.name]||!toBlock&&knode.isBlock()))if(0===pos){for(;!knode.prev()&&(parent=knode.parent(),parent&&!_NOSPLIT_TAG_MAP[parent.name]&&(toBlock||!parent.isBlock()));)knode=parent;isStart?self.setStartBefore(knode[0]):self.setEndBefore(knode[0])}else if(pos==knode.children().length){for(;!knode.next()&&(parent=knode.parent(),parent&&!_NOSPLIT_TAG_MAP[parent.name]&&(toBlock||!parent.isBlock()));)knode=parent;isStart?self.setStartAfter(knode[0]):self.setEndAfter(knode[0])}}var self=this;return self.up(),enlargePos(self.startContainer,self.startOffset,!0),enlargePos(self.endContainer,self.endOffset,!1),self},shrink:function(){for(var child,self=this,collapsed=self.collapsed;1==self.startContainer.nodeType&&(child=self.startContainer.childNodes[self.startOffset])&&1==child.nodeType&&!K(child).isSingle();)self.setStart(child,0);if(collapsed)return self.collapse(collapsed);for(;1==self.endContainer.nodeType&&self.endOffset>0&&(child=self.endContainer.childNodes[self.endOffset-1])&&1==child.nodeType&&!K(child).isSingle();)self.setEnd(child,child.childNodes.length);return self},createBookmark:function(serialize){var endNode,self=this,doc=self.doc,startNode=K('<span style="display:none;"></span>',doc)[0];return startNode.id="__kindeditor_bookmark_start_"+_BOOKMARK_ID++ +"__",self.collapsed||(endNode=startNode.cloneNode(!0),endNode.id="__kindeditor_bookmark_end_"+_BOOKMARK_ID++ +"__"),endNode&&self.cloneRange().collapse(!1).insertNode(endNode).setEndBefore(endNode),self.insertNode(startNode).setStartAfter(startNode),{start:serialize?"#"+startNode.id:startNode,end:endNode?serialize?"#"+endNode.id:endNode:null}},moveToBookmark:function(bookmark){var self=this,doc=self.doc,start=K(bookmark.start,doc),end=bookmark.end?K(bookmark.end,doc):null;return!start||start.length<1?self:(self.setStartBefore(start[0]),start.remove(),end&&end.length>0?(self.setEndBefore(end[0]),end.remove()):self.collapse(!0),self)},dump:function(){console.log("--------------------"),console.log(3==this.startContainer.nodeType?this.startContainer.nodeValue:this.startContainer,this.startOffset),console.log(3==this.endContainer.nodeType?this.endContainer.nodeValue:this.endContainer,this.endOffset)}}),K.RangeClass=KRange,K.range=_range,K.START_TO_START=_START_TO_START,K.START_TO_END=_START_TO_END,K.END_TO_END=_END_TO_END,K.END_TO_START=_END_TO_START,_extend(KCmd,{init:function(range){var self=this,doc=range.doc;self.doc=doc,self.win=_getWin(doc),self.sel=_getSel(doc),self.range=range},selection:function(forceReset){var self=this,doc=self.doc,rng=_getRng(doc);return self.sel=_getSel(doc),rng?(self.range=_range(rng),"html"==K(self.range.startContainer).name&&self.range.selectNodeContents(doc.body).collapse(!1),self):(forceReset&&self.range.selectNodeContents(doc.body).collapse(!1),self)},select:function(hasDummy){hasDummy=_undef(hasDummy,!0);var rng,self=this,sel=self.sel,range=self.range.cloneRange().shrink(),sc=range.startContainer,so=range.startOffset,doc=(range.endContainer,range.endOffset,_getDoc(sc)),win=self.win,hasU200b=!1;if(hasDummy&&1==sc.nodeType&&range.collapsed){if(_IERANGE){var dummy=K("<span>&nbsp;</span>",doc);range.insertNode(dummy[0]),rng=doc.body.createTextRange();try{rng.moveToElementText(dummy[0])}catch(ex){}return rng.collapse(!1),rng.select(),dummy.remove(),win.focus(),self}if(_WEBKIT){var children=sc.childNodes;(K(sc).isInline()||so>0&&K(children[so-1]).isInline()||children[so]&&K(children[so]).isInline())&&(range.insertNode(doc.createTextNode("​")),hasU200b=!0)}}if(_IERANGE)try{rng=range.get(!0),rng.select()}catch(e){}else if(hasU200b&&range.collapse(!1),rng=range.get(!0),sel.removeAllRanges(),sel.addRange(rng),doc!==document){var pos=K(rng.endContainer).pos();win.scrollTo(pos.x,pos.y)}return win.focus(),self},wrap:function(val){var wrapper,self=this,doc=self.doc,range=self.range;if(wrapper=K(val,doc),range.collapsed)return range.shrink(),range.insertNode(wrapper[0]).selectNodeContents(wrapper[0]),self;if(wrapper.isBlock()){for(var copyWrapper=wrapper.clone(!0),child=copyWrapper;child.first();)child=child.first();return child.append(range.extractContents()),range.insertNode(copyWrapper[0]).selectNode(copyWrapper[0]),self}range.enlarge();var bookmark=range.createBookmark(),ancestor=range.commonAncestor(),isStart=!1;return K(ancestor).scan(function(node){if(!isStart&&node==bookmark.start)return isStart=!0,void 0;if(isStart){if(node==bookmark.end)return!1;var knode=K(node);if(_inPreElement(knode))return;if(3==knode.type&&_trim(node.nodeValue).length>0){for(var parent;(parent=knode.parent())&&parent.isStyle()&&1==parent.children().length;)knode=parent;_wrapNode(knode,wrapper)}}}),range.moveToBookmark(bookmark),self},split:function(isStart,map){for(var knode,range=this.range,doc=range.doc,tempRange=range.cloneRange().collapse(isStart),node=tempRange.startContainer,pos=tempRange.startOffset,parent=3==node.nodeType?node.parentNode:node,needSplit=!1;parent&&parent.parentNode;){if(knode=K(parent),map){if(!knode.isStyle())break;if(!_hasAttrOrCss(knode,map))break}else if(_NOSPLIT_TAG_MAP[knode.name])break;needSplit=!0,parent=parent.parentNode}if(needSplit){var dummy=doc.createElement("span");range.cloneRange().collapse(!isStart).insertNode(dummy),isStart?tempRange.setStartBefore(parent.firstChild).setEnd(node,pos):tempRange.setStart(node,pos).setEndAfter(parent.lastChild);var frag=tempRange.extractContents(),first=frag.firstChild,last=frag.lastChild;isStart?(tempRange.insertNode(frag),range.setStartAfter(last).setEndBefore(dummy)):(parent.appendChild(frag),range.setStartBefore(dummy).setEndBefore(first));var dummyParent=dummy.parentNode;if(dummyParent==range.endContainer){var prev=K(dummy).prev(),next=K(dummy).next();prev&&next&&3==prev.type&&3==next.type?range.setEnd(prev[0],prev[0].nodeValue.length):isStart||range.setEnd(range.endContainer,range.endOffset-1)}dummyParent.removeChild(dummy)}return this},remove:function(map){var self=this,doc=self.doc,range=self.range;if(range.enlarge(),0===range.startOffset){for(var parent,ksc=K(range.startContainer);(parent=ksc.parent())&&parent.isStyle()&&1==parent.children().length;)ksc=parent;range.setStart(ksc[0],0),ksc=K(range.startContainer),ksc.isBlock()&&_removeAttrOrCss(ksc,map);var kscp=ksc.parent();kscp&&kscp.isBlock()&&_removeAttrOrCss(kscp,map)}var sc,so;if(range.collapsed){if(self.split(!0,map),sc=range.startContainer,so=range.startOffset,so>0){var sb=K(sc.childNodes[so-1]);sb&&_isEmptyNode(sb)&&(sb.remove(),range.setStart(sc,so-1))}var sa=K(sc.childNodes[so]);return sa&&_isEmptyNode(sa)&&sa.remove(),_isEmptyNode(sc)&&(range.startBefore(sc),sc.remove()),range.collapse(!0),self}self.split(!0,map),self.split(!1,map);var startDummy=doc.createElement("span"),endDummy=doc.createElement("span");range.cloneRange().collapse(!1).insertNode(endDummy),range.cloneRange().collapse(!0).insertNode(startDummy);var nodeList=[],cmpStart=!1;K(range.commonAncestor()).scan(function(node){return cmpStart||node!=startDummy?node==endDummy?!1:(cmpStart&&nodeList.push(node),void 0):(cmpStart=!0,void 0)}),K(startDummy).remove(),K(endDummy).remove(),sc=range.startContainer,so=range.startOffset;var ec=range.endContainer,eo=range.endOffset;if(so>0){var startBefore=K(sc.childNodes[so-1]);startBefore&&_isEmptyNode(startBefore)&&(startBefore.remove(),range.setStart(sc,so-1),sc==ec&&range.setEnd(ec,eo-1));var startAfter=K(sc.childNodes[so]);startAfter&&_isEmptyNode(startAfter)&&(startAfter.remove(),sc==ec&&range.setEnd(ec,eo-1))}var endAfter=K(ec.childNodes[range.endOffset]);endAfter&&_isEmptyNode(endAfter)&&endAfter.remove();var bookmark=range.createBookmark(!0);return _each(nodeList,function(i,node){_removeAttrOrCss(K(node),map)}),range.moveToBookmark(bookmark),self},commonNode:function(map){function find(node){for(var child=node,parent=node;parent;){if(_hasAttrOrCss(K(parent),map))return K(parent);parent=parent.parentNode}for(;child&&(child=child.lastChild);)if(_hasAttrOrCss(K(child),map))return K(child);return null}var range=this.range,ec=range.endContainer,eo=range.endOffset,node=3==ec.nodeType||0===eo?ec:ec.childNodes[eo-1],cNode=find(node);if(cNode)return cNode;if(1==node.nodeType||3==ec.nodeType&&0===eo){var prev=K(node).prev();if(prev)return find(prev)}return null},commonAncestor:function(tagName){function find(node){for(;node;){if(1==node.nodeType&&node.tagName.toLowerCase()===tagName)return node;node=node.parentNode}return null}var range=this.range,sc=range.startContainer,so=range.startOffset,ec=range.endContainer,eo=range.endOffset,startNode=3==sc.nodeType||0===so?sc:sc.childNodes[so-1],endNode=3==ec.nodeType||0===eo?ec:ec.childNodes[eo-1],start=find(startNode),end=find(endNode);return start&&end&&start===end?K(start):null},state:function(key){var self=this,doc=self.doc,bool=!1;try{bool=doc.queryCommandState(key)}catch(e){}return bool},val:function(key){function lc(val){return val.toLowerCase()}{var self=this,doc=self.doc;self.range}key=lc(key);var knode,val="";return"fontfamily"===key||"fontname"===key?(val=_nativeCommandValue(doc,"fontname"),val=val.replace(/['"]/g,""),lc(val)):"formatblock"===key?(val=_nativeCommandValue(doc,key),""===val&&(knode=self.commonNode({"h1,h2,h3,h4,h5,h6,p,div,pre,address":"*"}),knode&&(val=knode.name)),"Normal"===val&&(val="p"),lc(val)):"fontsize"===key?(knode=self.commonNode({"*":".font-size"}),knode&&(val=knode.css("font-size")),lc(val)):"forecolor"===key?(knode=self.commonNode({"*":".color"}),knode&&(val=knode.css("color")),val=_toHex(val),""===val&&(val="default"),lc(val)):"hilitecolor"===key?(knode=self.commonNode({"*":".background-color"}),knode&&(val=knode.css("background-color")),val=_toHex(val),""===val&&(val="default"),lc(val)):val},toggle:function(wrapper,map){var self=this;return self.commonNode(map)?self.remove(map):self.wrap(wrapper),self.select()},bold:function(){return this.toggle("<strong></strong>",{span:".font-weight=bold",strong:"*",b:"*"})},italic:function(){return this.toggle("<em></em>",{span:".font-style=italic",em:"*",i:"*"})},underline:function(){return this.toggle("<u></u>",{span:".text-decoration=underline",u:"*"})},strikethrough:function(){return this.toggle("<s></s>",{span:".text-decoration=line-through",s:"*"})},forecolor:function(val){return this.wrap('<span style="color:'+val+';"></span>').select()},hilitecolor:function(val){return this.wrap('<span style="background-color:'+val+';"></span>').select()},fontsize:function(val){return this.wrap('<span style="font-size:'+val+';"></span>').select()},fontname:function(val){return this.fontfamily(val)},fontfamily:function(val){return this.wrap('<span style="font-family:'+val+';"></span>').select()},removeformat:function(){var map={"*":".font-weight,.font-style,.text-decoration,.color,.background-color,.font-size,.font-family,.text-indent"},tags=_STYLE_TAG_MAP;return _each(tags,function(key){map[key]="*"}),this.remove(map),this.select()},inserthtml:function(val,quickMode){function pasteHtml(range,val){val='<img id="__kindeditor_temp_tag__" width="0" height="0" style="display:none;" />'+val;var rng=range.get();rng.item?rng.item(0).outerHTML=val:rng.pasteHTML(val);var temp=range.doc.getElementById("__kindeditor_temp_tag__");temp.parentNode.removeChild(temp);var newRange=_toRange(rng);range.setEnd(newRange.endContainer,newRange.endOffset),range.collapse(!1),self.select(!1)}function insertHtml(range,val){var doc=range.doc,frag=doc.createDocumentFragment();K("@"+val,doc).each(function(){frag.appendChild(this)}),range.deleteContents(),range.insertNode(frag),range.collapse(!1),self.select(!1)}var self=this,range=self.range;if(""===val)return self;if(_IERANGE&&quickMode){try{pasteHtml(range,val)}catch(e){insertHtml(range,val)}return self}return insertHtml(range,val),self},hr:function(){return this.inserthtml("<hr />")},print:function(){return this.win.print(),this},insertimage:function(url,title,width,height,border,align){title=_undef(title,""),border=_undef(border,0);var html='<img src="'+_escape(url)+'" data-ke-src="'+_escape(url)+'" ';return width&&(html+='width="'+_escape(width)+'" '),height&&(html+='height="'+_escape(height)+'" '),title&&(html+='title="'+_escape(title)+'" '),align&&(html+='align="'+_escape(align)+'" '),html+='alt="'+_escape(title)+'" ',html+="/>",this.inserthtml(html)},createlink:function(url,type){function setAttr(node,url,type){K(node).attr("href",url).attr("data-ke-src",url),type?K(node).attr("target",type):K(node).removeAttr("target")}var self=this,doc=self.doc,range=self.range;self.select();var a=self.commonNode({a:"*"});a&&!range.isControl()&&(range.selectNode(a.get()),self.select());var html='<a href="'+_escape(url)+'" data-ke-src="'+_escape(url)+'" ';if(type&&(html+=' target="'+_escape(type)+'"'),range.collapsed)return html+=">"+_escape(url)+"</a>",self.inserthtml(html);if(range.isControl()){var node=K(range.startContainer.childNodes[range.startOffset]);return html+="></a>",node.after(K(html,doc)),node.next().append(node),range.selectNode(node[0]),self.select()}var sc=range.startContainer,so=range.startOffset,ec=range.endContainer,eo=range.endOffset;if(1==sc.nodeType&&sc===ec&&so+1===eo){var child=sc.childNodes[so];if("a"==child.nodeName.toLowerCase())return setAttr(child,url,type),self}return _nativeCommand(doc,"createlink","__kindeditor_temp_url__"),K('a[href="__kindeditor_temp_url__"]',doc).each(function(){setAttr(this,url,type)}),self},unlink:function(){var self=this,doc=self.doc,range=self.range;if(self.select(),range.collapsed){var a=self.commonNode({a:"*"});if(a&&(range.selectNode(a.get()),self.select()),_nativeCommand(doc,"unlink",null),_WEBKIT&&"img"===K(range.startContainer).name){var parent=K(range.startContainer).parent();"a"===parent.name&&parent.remove(!0)}}else _nativeCommand(doc,"unlink",null);return self}}),_each("formatblock,selectall,justifyleft,justifycenter,justifyright,justifyfull,insertorderedlist,insertunorderedlist,indent,outdent,subscript,superscript".split(","),function(i,name){KCmd.prototype[name]=function(val){var self=this;return self.select(),_nativeCommand(self.doc,name,val),_IERANGE&&_inArray(name,"justifyleft,justifycenter,justifyright,justifyfull".split(","))>=0&&self.selection(),(!_IERANGE||_inArray(name,"formatblock,selectall,insertorderedlist,insertunorderedlist".split(","))>=0)&&self.selection(),self}}),_each("cut,copy,paste".split(","),function(i,name){KCmd.prototype[name]=function(){var self=this;if(!self.doc.queryCommandSupported(name))throw"not supported";return self.select(),_nativeCommand(self.doc,name,null),self}}),K.CmdClass=KCmd,K.cmd=_cmd,_extend(KWidget,{init:function(options){var self=this;if(self.name=options.name||"",self.doc=options.doc||document,self.win=_getWin(self.doc),self.x=_addUnit(options.x),self.y=_addUnit(options.y),self.z=options.z,self.width=_addUnit(options.width),self.height=_addUnit(options.height),self.div=K('<div style="display:block;"></div>'),self.options=options,self._alignEl=options.alignEl,self.width&&self.div.css("width",self.width),self.height&&self.div.css("height",self.height),self.z&&self.div.css({position:"absolute",left:self.x,top:self.y,"z-index":self.z}),!self.z||self.x!==undefined&&self.y!==undefined||self.autoPos(self.width,self.height),options.cls&&self.div.addClass(options.cls),options.shadowMode&&self.div.addClass("ke-shadow"),options.css&&self.div.css(options.css),options.src?K(options.src).replaceWith(self.div):K(self.doc.body).append(self.div),options.html&&self.div.html(options.html),options.autoScroll)if(_IE&&7>_V||_QUIRKS){var scrollPos=_getScrollPos();K(self.win).bind("scroll",function(){var pos=_getScrollPos(),diffX=pos.x-scrollPos.x,diffY=pos.y-scrollPos.y;self.pos(_removeUnit(self.x)+diffX,_removeUnit(self.y)+diffY,!1)})}else self.div.css("position","fixed")},pos:function(x,y,updateProp){var self=this;return updateProp=_undef(updateProp,!0),null!==x&&(x=0>x?0:_addUnit(x),self.div.css("left",x),updateProp&&(self.x=x)),null!==y&&(y=0>y?0:_addUnit(y),self.div.css("top",y),updateProp&&(self.y=y)),self},autoPos:function(width,height){var self=this,w=_removeUnit(width)||0,h=_removeUnit(height)||0,scrollPos=_getScrollPos();if(self._alignEl){var knode=K(self._alignEl),pos=knode.pos(),diffX=_round(knode[0].clientWidth/2-w/2),diffY=_round(knode[0].clientHeight/2-h/2);x=0>diffX?pos.x:pos.x+diffX,y=0>diffY?pos.y:pos.y+diffY}else{var docEl=_docElement(self.doc);x=_round(scrollPos.x+(docEl.clientWidth-w)/2),y=_round(scrollPos.y+(docEl.clientHeight-h)/2)}return _IE&&7>_V||_QUIRKS||(x-=scrollPos.x,y-=scrollPos.y),self.pos(x,y)},remove:function(){var self=this;return(_IE&&7>_V||_QUIRKS)&&K(self.win).unbind("scroll"),self.div.remove(),_each(self,function(i){self[i]=null}),this},show:function(){return this.div.show(),this},hide:function(){return this.div.hide(),this},draggable:function(options){var self=this;return options=options||{},options.moveEl=self.div,options.moveFn=function(x,y,width,height,diffX,diffY){(x+=diffX)<0&&(x=0),(y+=diffY)<0&&(y=0),self.pos(x,y)},_drag(options),self}}),K.WidgetClass=KWidget,K.widget=_widget;var html,_direction="";(html=document.getElementsByTagName("html"))&&(_direction=html[0].dir),_extend(KEdit,KWidget,{init:function(options){function ready(){var doc=_iframeDoc(self.iframe);doc.open(),isDocumentDomain&&(doc.domain=document.domain),doc.write(_getInitHtml(themesPath,bodyClass,cssPath,cssData)),doc.close(),self.win=self.iframe[0].contentWindow,self.doc=doc;var cmd=_cmd(doc);self.afterChange(function(){cmd.selection()}),_WEBKIT&&K(doc).click(function(e){"img"===K(e.target).name&&(cmd.selection(!0),cmd.range.selectNode(e.target),cmd.select())}),_IE&&(self._mousedownHandler=function(){var newRange=cmd.range.cloneRange();newRange.shrink(),newRange.isControl()&&self.blur()},K(document).mousedown(self._mousedownHandler),K(doc).keydown(function(e){if(8==e.which){cmd.selection();var rng=cmd.range;rng.isControl()&&(rng.collapse(!0),K(rng.startContainer.childNodes[rng.startOffset]).remove(),e.preventDefault())}})),self.cmd=cmd,self.html(_elementVal(self.srcElement)),_IE?(doc.body.disabled=!0,doc.body.contentEditable=!0,doc.body.removeAttribute("disabled")):doc.designMode="on",options.afterCreate&&options.afterCreate.call(self)}var self=this;KEdit.parent.init.call(self,options),self.srcElement=K(options.srcElement),self.div.addClass("ke-edit"),self.designMode=_undef(options.designMode,!0),self.beforeGetHtml=options.beforeGetHtml,self.beforeSetHtml=options.beforeSetHtml,self.afterSetHtml=options.afterSetHtml;var themesPath=_undef(options.themesPath,""),bodyClass=options.bodyClass,cssPath=options.cssPath,cssData=options.cssData,isDocumentDomain="res:"!=location.protocol&&location.host.replace(/:\d+/,"")!==document.domain,srcScript="document.open();"+(isDocumentDomain?'document.domain="'+document.domain+'";':"")+"document.close();",iframeSrc=_IE?' src="javascript:void(function(){'+encodeURIComponent(srcScript)+'}())"':"";self.iframe=K('<iframe class="ke-edit-iframe" hidefocus="true" frameborder="0"'+iframeSrc+"></iframe>").css("width","100%"),self.textarea=K('<textarea class="ke-edit-textarea" hidefocus="true"></textarea>').css("width","100%"),self.tabIndex=isNaN(parseInt(options.tabIndex,10))?self.srcElement.attr("tabindex"):parseInt(options.tabIndex,10),self.iframe.attr("tabindex",self.tabIndex),self.textarea.attr("tabindex",self.tabIndex),self.width&&self.setWidth(self.width),self.height&&self.setHeight(self.height),self.designMode?self.textarea.hide():self.iframe.hide(),isDocumentDomain&&self.iframe.bind("load",function(){self.iframe.unbind("load"),_IE?ready():setTimeout(ready,0)}),self.div.append(self.iframe),self.div.append(self.textarea),self.srcElement.hide(),!isDocumentDomain&&ready()},setWidth:function(val){var self=this;return val=_addUnit(val),self.width=val,self.div.css("width",val),self},setHeight:function(val){var self=this;return val=_addUnit(val),self.height=val,self.div.css("height",val),self.iframe.css("height",val),(_IE&&8>_V||_QUIRKS)&&(val=_addUnit(_removeUnit(val)-2)),self.textarea.css("height",val),self},remove:function(){var self=this,doc=self.doc;K(doc.body).unbind(),K(doc).unbind(),K(self.win).unbind(),self._mousedownHandler&&K(document).unbind("mousedown",self._mousedownHandler),_elementVal(self.srcElement,self.html()),self.srcElement.show(),doc.write(""),self.iframe.unbind(),self.textarea.unbind(),KEdit.parent.remove.call(self)},html:function(val,isFull){var self=this,doc=self.doc;if(self.designMode){var body=doc.body;return val===undefined?(val=isFull?"<!doctype html><html>"+body.parentNode.innerHTML+"</html>":body.innerHTML,self.beforeGetHtml&&(val=self.beforeGetHtml(val)),_GECKO&&"<br />"==val&&(val=""),val):(self.beforeSetHtml&&(val=self.beforeSetHtml(val)),_IE&&_V>=9&&(val=val.replace(/(<.*?checked=")checked(".*>)/gi,"$1$2")),K(body).html(val),self.afterSetHtml&&self.afterSetHtml(),self)}return val===undefined?self.textarea.val():(self.textarea.val(val),self)},design:function(bool){var val,self=this;return(bool===undefined?!self.designMode:bool)?self.designMode||(val=self.html(),self.designMode=!0,self.html(val),self.textarea.hide(),self.iframe.show()):self.designMode&&(val=self.html(),self.designMode=!1,self.html(val),self.iframe.hide(),self.textarea.show()),self.focus()},focus:function(){var self=this;return self.designMode?self.win.focus():self.textarea[0].focus(),self},blur:function(){var self=this;if(_IE){var input=K('<input type="text" style="float:left;width:0;height:0;padding:0;margin:0;border:0;" value="" />',self.div);self.div.append(input),input[0].focus(),input.remove()}else self.designMode?self.win.blur():self.textarea[0].blur();return self},afterChange:function(fn){function timeoutHandler(e){setTimeout(function(){fn(e)},1)}var self=this,doc=self.doc,body=doc.body;return K(doc).keyup(function(e){e.ctrlKey||e.altKey||!_CHANGE_KEY_MAP[e.which]||fn(e)}),K(doc).mouseup(fn).contextmenu(fn),K(self.win).blur(fn),K(body).bind("paste",timeoutHandler),K(body).bind("cut",timeoutHandler),self}}),K.EditClass=KEdit,K.edit=_edit,K.iframeDoc=_iframeDoc,_extend(KToolbar,KWidget,{init:function(options){function find(target){var knode=K(target);return knode.hasClass("ke-outline")?knode:knode.hasClass("ke-toolbar-icon")?knode.parent():void 0}function hover(e,method){var knode=find(e.target);if(knode){if(knode.hasClass("ke-disabled"))return;if(knode.hasClass("ke-selected"))return;knode[method]("ke-on")}}var self=this;KToolbar.parent.init.call(self,options),self.disableMode=_undef(options.disableMode,!1),self.noDisableItemMap=_toMap(_undef(options.noDisableItems,[])),self._itemMap={},self.div.addClass("ke-toolbar").bind("contextmenu,mousedown,mousemove",function(e){e.preventDefault()}).attr("unselectable","on"),self.div.mouseover(function(e){hover(e,"addClass")}).mouseout(function(e){hover(e,"removeClass")}).click(function(e){var knode=find(e.target);if(knode){if(knode.hasClass("ke-disabled"))return;self.options.click.call(this,e,knode.attr("data-name"))}})},get:function(name){return this._itemMap[name]?this._itemMap[name]:this._itemMap[name]=K("span.ke-icon-"+name,this.div).parent()},select:function(name){return _selectToolbar.call(this,name,function(knode){knode.addClass("ke-selected")}),self},unselect:function(name){return _selectToolbar.call(this,name,function(knode){knode.removeClass("ke-selected").removeClass("ke-on")}),self},enable:function(name){var self=this,knode=name.get?name:self.get(name);return knode&&(knode.removeClass("ke-disabled"),knode.opacity(1)),self},disable:function(name){var self=this,knode=name.get?name:self.get(name);return knode&&(knode.removeClass("ke-selected").addClass("ke-disabled"),knode.opacity(.5)),self},disableAll:function(bool,noDisableItems){var self=this,map=self.noDisableItemMap;return noDisableItems&&(map=_toMap(noDisableItems)),(bool===undefined?!self.disableMode:bool)?(K("span.ke-outline",self.div).each(function(){var knode=K(this),name=knode[0].getAttribute("data-name",2);map[name]||self.disable(knode)}),self.disableMode=!0):(K("span.ke-outline",self.div).each(function(){var knode=K(this),name=knode[0].getAttribute("data-name",2);map[name]||self.enable(knode)}),self.disableMode=!1),self}}),K.ToolbarClass=KToolbar,K.toolbar=_toolbar,_extend(KMenu,KWidget,{init:function(options){var self=this;options.z=options.z||811213,KMenu.parent.init.call(self,options),self.centerLineMode=_undef(options.centerLineMode,!0),self.div.addClass("ke-menu").bind("click,mousedown",function(e){e.stopPropagation()}).attr("unselectable","on")},addItem:function(item){var self=this;if("-"===item.title)return self.div.append(K('<div class="ke-menu-separator"></div>')),void 0;var itemDiv=K('<div class="ke-menu-item" unselectable="on"></div>'),leftDiv=K('<div class="ke-inline-block ke-menu-item-left"></div>'),rightDiv=K('<div class="ke-inline-block ke-menu-item-right"></div>'),height=_addUnit(item.height),iconClass=_undef(item.iconClass,"");self.div.append(itemDiv),height&&(itemDiv.css("height",height),rightDiv.css("line-height",height));var centerDiv;return self.centerLineMode&&(centerDiv=K('<div class="ke-inline-block ke-menu-item-center"></div>'),height&&centerDiv.css("height",height)),itemDiv.mouseover(function(){K(this).addClass("ke-menu-item-on"),centerDiv&&centerDiv.addClass("ke-menu-item-center-on")}).mouseout(function(){K(this).removeClass("ke-menu-item-on"),centerDiv&&centerDiv.removeClass("ke-menu-item-center-on")}).click(function(e){item.click.call(K(this)),e.stopPropagation()}).append(leftDiv),centerDiv&&itemDiv.append(centerDiv),itemDiv.append(rightDiv),item.checked&&(iconClass="ke-icon-checked"),""!==iconClass&&leftDiv.html('<span class="ke-inline-block ke-toolbar-icon ke-toolbar-icon-url '+iconClass+'"></span>'),rightDiv.html(item.title),self},remove:function(){var self=this;return self.options.beforeRemove&&self.options.beforeRemove.call(self),K(".ke-menu-item",self.div[0]).unbind(),KMenu.parent.remove.call(self),self}}),K.MenuClass=KMenu,K.menu=_menu,_extend(KColorPicker,KWidget,{init:function(options){var self=this;options.z=options.z||811213,KColorPicker.parent.init.call(self,options);var colors=options.colors||[["#E53333","#E56600","#FF9900","#64451D","#DFC5A4","#FFE500"],["#009900","#006600","#99BB00","#B8D100","#60D978","#00D5FF"],["#337FE5","#003399","#4C33E5","#9933E5","#CC33E5","#EE33EE"],["#FFFFFF","#CCCCCC","#999999","#666666","#333333","#000000"]];self.selectedColor=(options.selectedColor||"").toLowerCase(),self._cells=[],self.div.addClass("ke-colorpicker").bind("click,mousedown",function(e){e.stopPropagation()}).attr("unselectable","on");var table=self.doc.createElement("table");self.div.append(table),table.className="ke-colorpicker-table",table.cellPadding=0,table.cellSpacing=0,table.border=0;var row=table.insertRow(0),cell=row.insertCell(0);cell.colSpan=colors[0].length,self._addAttr(cell,"","ke-colorpicker-cell-top");for(var i=0;i<colors.length;i++){row=table.insertRow(i+1);for(var j=0;j<colors[i].length;j++)cell=row.insertCell(j),self._addAttr(cell,colors[i][j],"ke-colorpicker-cell")}},_addAttr:function(cell,color,cls){var self=this;cell=K(cell).addClass(cls),self.selectedColor===color.toLowerCase()&&cell.addClass("ke-colorpicker-cell-selected"),cell.attr("title",color||self.options.noColor),cell.mouseover(function(){K(this).addClass("ke-colorpicker-cell-on")}),cell.mouseout(function(){K(this).removeClass("ke-colorpicker-cell-on")}),cell.click(function(e){e.stop(),self.options.click.call(K(this),color)}),color?cell.append(K('<div class="ke-colorpicker-cell-color" unselectable="on"></div>').css("background-color",color)):cell.html(self.options.noColor),K(cell).attr("unselectable","on"),self._cells.push(cell)},remove:function(){var self=this;return _each(self._cells,function(){this.unbind()}),KColorPicker.parent.remove.call(self),self}}),K.ColorPickerClass=KColorPicker,K.colorpicker=_colorpicker,_extend(KUploadButton,{init:function(options){var self=this,button=K(options.button),fieldName=options.fieldName||"file",url=options.url||"",title=button.val(),extraParams=options.extraParams||{},cls=button[0].className||"",target=options.target||"kindeditor_upload_iframe_"+(new Date).getTime();options.afterError=options.afterError||function(str){alert(str)};var hiddenElements=[];for(var k in extraParams)hiddenElements.push('<input type="hidden" name="'+k+'" value="'+extraParams[k]+'" />');var html=['<div class="ke-inline-block '+cls+'">',options.target?"":'<iframe name="'+target+'" style="display:none;"></iframe>',options.form?'<div class="ke-upload-area">':'<form class="ke-upload-area ke-form" method="post" enctype="multipart/form-data" target="'+target+'" action="'+url+'">','<span class="ke-button-common">',hiddenElements.join(""),'<input type="button" class="ke-button-common ke-button" value="'+title+'" />',"</span>",'<input type="file" class="ke-upload-file" name="'+fieldName+'" tabindex="-1" />',options.form?"</div>":"</form>","</div>"].join(""),div=K(html,button.doc);button.hide(),button.before(div),self.div=div,self.button=button,self.iframe=options.target?K('iframe[name="'+target+'"]'):K("iframe",div),self.form=options.form?K(options.form):K("form",div),self.fileBox=K(".ke-upload-file",div);var width=options.width||K(".ke-button-common",div).width();K(".ke-upload-area",div).width(width),self.options=options},submit:function(){var self=this,iframe=self.iframe;return iframe.bind("load",function(){iframe.unbind();var tempForm=document.createElement("form");self.fileBox.before(tempForm),K(tempForm).append(self.fileBox),tempForm.reset(),K(tempForm).remove(!0);var data,doc=K.iframeDoc(iframe),pre=doc.getElementsByTagName("pre")[0],str="";str=pre?pre.innerHTML:doc.body.innerHTML,str=_unescape(str),iframe[0].src="javascript:false";try{data=K.json(str)}catch(e){self.options.afterError.call(self,"<!doctype html><html>"+doc.body.parentNode.innerHTML+"</html>")}data&&self.options.afterUpload.call(self,data)}),self.form[0].submit(),self},remove:function(){var self=this;return self.fileBox&&self.fileBox.unbind(),self.iframe.remove(),self.div.remove(),self.button.show(),self}}),K.UploadButtonClass=KUploadButton,K.uploadbutton=_uploadbutton,_extend(KDialog,KWidget,{init:function(options){var self=this,shadowMode=_undef(options.shadowMode,!0);
options.z=options.z||811213,options.shadowMode=!1,options.autoScroll=_undef(options.autoScroll,!0),KDialog.parent.init.call(self,options);var title=options.title,body=K(options.body,self.doc),previewBtn=options.previewBtn,yesBtn=options.yesBtn,noBtn=options.noBtn,closeBtn=options.closeBtn,showMask=_undef(options.showMask,!0);self.div.addClass("ke-dialog").bind("click,mousedown",function(e){e.stopPropagation()});var contentDiv=K('<div class="ke-dialog-content"></div>').appendTo(self.div);_IE&&7>_V?self.iframeMask=K('<iframe src="about:blank" class="ke-dialog-shadow"></iframe>').appendTo(self.div):shadowMode&&K('<div class="ke-dialog-shadow"></div>').appendTo(self.div);var headerDiv=K('<div class="ke-dialog-header"></div>');contentDiv.append(headerDiv),headerDiv.html(title),self.closeIcon=K('<span class="ke-dialog-icon-close" title="'+closeBtn.name+'"></span>').click(closeBtn.click),headerDiv.append(self.closeIcon),self.draggable({clickEl:headerDiv,beforeDrag:options.beforeDrag});var bodyDiv=K('<div class="ke-dialog-body"></div>');contentDiv.append(bodyDiv),bodyDiv.append(body);var footerDiv=K('<div class="ke-dialog-footer"></div>');if((previewBtn||yesBtn||noBtn)&&contentDiv.append(footerDiv),_each([{btn:previewBtn,name:"preview"},{btn:yesBtn,name:"yes"},{btn:noBtn,name:"no"}],function(){if(this.btn){var button=_createButton(this.btn);button.addClass("ke-dialog-"+this.name),footerDiv.append(button)}}),self.height&&bodyDiv.height(_removeUnit(self.height)-headerDiv.height()-footerDiv.height()),self.div.width(self.div.width()),self.div.height(self.div.height()),self.mask=null,showMask){var docEl=_docElement(self.doc),docWidth=Math.max(docEl.scrollWidth,docEl.clientWidth),docHeight=Math.max(docEl.scrollHeight,docEl.clientHeight);self.mask=_widget({x:0,y:0,z:self.z-1,cls:"ke-dialog-mask",width:docWidth,height:docHeight})}self.autoPos(self.div.width(),self.div.height()),self.footerDiv=footerDiv,self.bodyDiv=bodyDiv,self.headerDiv=headerDiv,self.isLoading=!1},setMaskIndex:function(z){var self=this;self.mask.div.css("z-index",z)},showLoading:function(msg){msg=_undef(msg,"");var self=this,body=self.bodyDiv;return self.loading=K('<div class="ke-dialog-loading"><div class="ke-inline-block ke-dialog-loading-content" style="margin-top:'+Math.round(body.height()/3)+'px;">'+msg+"</div></div>").width(body.width()).height(body.height()).css("top",self.headerDiv.height()+"px"),body.css("visibility","hidden").after(self.loading),self.isLoading=!0,self},hideLoading:function(){return this.loading&&this.loading.remove(),this.bodyDiv.css("visibility","visible"),this.isLoading=!1,this},remove:function(){var self=this;return self.options.beforeRemove&&self.options.beforeRemove.call(self),self.mask&&self.mask.remove(),self.iframeMask&&self.iframeMask.remove(),self.closeIcon.unbind(),K("input",self.div).unbind(),K("button",self.div).unbind(),self.footerDiv.unbind(),self.bodyDiv.unbind(),self.headerDiv.unbind(),K("iframe",self.div).each(function(){K(this).remove()}),KDialog.parent.remove.call(self),self}}),K.DialogClass=KDialog,K.dialog=_dialog,K.tabs=_tabs,K.loadScript=_loadScript,K.loadStyle=_loadStyle,K.ajax=_ajax;var _plugins={},_language={};KEditor.prototype={lang:function(mixed){return _lang(mixed,this.langType)},loadPlugin:function(name,fn){var self=this;return _plugins[name]?_isFunction(_plugins[name])?(_plugins[name].call(self,KindEditor),fn&&fn.call(self),self):(setTimeout(function(){self.loadPlugin(name,fn)},100),self):(_plugins[name]="loading",_loadScript(self.pluginsPath+name+"/"+name+".js?ver="+encodeURIComponent(K.DEBUG?_TIME:_VERSION),function(){setTimeout(function(){_plugins[name]&&self.loadPlugin(name,fn)},0)}),self)},handler:function(key,fn){var self=this;return self._handlers[key]||(self._handlers[key]=[]),_isFunction(fn)?(self._handlers[key].push(fn),self):(_each(self._handlers[key],function(){fn=this.call(self,fn)}),fn)},clickToolbar:function(name,fn){var self=this,key="clickToolbar"+name;return fn===undefined?self._handlers[key]?self.handler(key):(self.loadPlugin(name,function(){self.handler(key)}),self):self.handler(key,fn)},updateState:function(){var self=this;return _each("justifyleft,justifycenter,justifyright,justifyfull,insertorderedlist,insertunorderedlist,subscript,superscript,bold,italic,underline,strikethrough".split(","),function(i,name){self.cmd.state(name)?self.toolbar.select(name):self.toolbar.unselect(name)}),self},addContextmenu:function(item){return this._contextmenus.push(item),this},afterCreate:function(fn){return this.handler("afterCreate",fn)},beforeRemove:function(fn){return this.handler("beforeRemove",fn)},beforeGetHtml:function(fn){return this.handler("beforeGetHtml",fn)},beforeSetHtml:function(fn){return this.handler("beforeSetHtml",fn)},afterSetHtml:function(fn){return this.handler("afterSetHtml",fn)},create:function(){function initResize(){return 0===statusbar.height()?(setTimeout(initResize,100),void 0):(self.resize(width,height,!1),void 0)}var self=this,fullscreenMode=self.fullscreenMode;if(self.isCreated)return self;if(self.srcElement.data("kindeditor"))return self;self.srcElement.data("kindeditor","true"),_docElement().style.overflow=fullscreenMode?"hidden":"";var width=fullscreenMode?_docElement().clientWidth+"px":self.width,height=fullscreenMode?_docElement().clientHeight+"px":self.height;(_IE&&8>_V||_QUIRKS)&&(height=_addUnit(_removeUnit(height)+2));var container=self.container=K(self.layout);fullscreenMode?K(document.body).append(container):self.srcElement.before(container);var toolbarDiv=K(".toolbar",container),editDiv=K(".edit",container),statusbar=self.statusbar=K(".statusbar",container);container.removeClass("container").addClass("ke-container ke-container-"+self.themeType).css("width",width),fullscreenMode?(container.css({position:"absolute",left:0,top:0,"z-index":811211}),_GECKO||(self._scrollPos=_getScrollPos()),window.scrollTo(0,0),K(document.body).css({height:"1px",overflow:"hidden"}),K(document.body.parentNode).css("overflow","hidden"),self._fullscreenExecuted=!0):(self._fullscreenExecuted&&(K(document.body).css({height:"",overflow:""}),K(document.body.parentNode).css("overflow","")),self._scrollPos&&window.scrollTo(self._scrollPos.x,self._scrollPos.y));var htmlList=[];K.each(self.items,function(i,name){"|"==name?htmlList.push('<span class="ke-inline-block ke-separator"></span>'):"/"==name?htmlList.push('<div class="ke-hr"></div>'):(htmlList.push('<span class="ke-outline" data-name="'+name+'" title="'+self.lang(name)+'" unselectable="on">'),htmlList.push('<span class="ke-toolbar-icon ke-toolbar-icon-url ke-icon-'+name+'" unselectable="on"></span></span>'))});var toolbar=self.toolbar=_toolbar({src:toolbarDiv,html:htmlList.join(""),noDisableItems:self.noDisableItems,click:function(e,name){if(e.stop(),self.menu){var menuName=self.menu.name;if(self.hideMenu(),menuName===name)return}self.clickToolbar(name)}}),editHeight=_removeUnit(height)-toolbar.div.height(),edit=self.edit=_edit({height:editHeight>0&&_removeUnit(height)>self.minHeight?editHeight:self.minHeight,src:editDiv,srcElement:self.srcElement,designMode:self.designMode,themesPath:self.themesPath,bodyClass:self.bodyClass,cssPath:self.cssPath,cssData:self.cssData,beforeGetHtml:function(html){return html=self.beforeGetHtml(html),html=_removeBookmarkTag(_removeTempTag(html)),_formatHtml(html,self.filterMode?self.htmlTags:null,self.urlType,self.wellFormatMode,self.indentChar)},beforeSetHtml:function(html){return html=_formatHtml(html,self.filterMode?self.htmlTags:null,"",!1),self.beforeSetHtml(html)},afterSetHtml:function(){self.edit=edit=this,self.afterSetHtml()},afterCreate:function(){if(self.edit=edit=this,self.cmd=edit.cmd,self._docMousedownFn=function(){self.menu&&self.hideMenu()},K(edit.doc,document).mousedown(self._docMousedownFn),_bindContextmenuEvent.call(self),_bindNewlineEvent.call(self),_bindTabEvent.call(self),_bindFocusEvent.call(self),edit.afterChange(function(){edit.designMode&&(self.updateState(),self.addBookmark(),self.options.afterChange&&self.options.afterChange.call(self))}),edit.textarea.keyup(function(e){e.ctrlKey||e.altKey||!_INPUT_KEY_MAP[e.which]||self.options.afterChange&&self.options.afterChange.call(self)}),self.readonlyMode&&self.readonly(),self.isCreated=!0,""===self.initContent&&(self.initContent=self.html()),self._undoStack.length>0){var prev=self._undoStack.pop();prev.start&&(self.html(prev.html),edit.cmd.range.moveToBookmark(prev),self.select())}self.afterCreate(),self.options.afterCreate&&self.options.afterCreate.call(self)}});return statusbar.removeClass("statusbar").addClass("ke-statusbar").append('<span class="ke-inline-block ke-statusbar-center-icon"></span>').append('<span class="ke-inline-block ke-statusbar-right-icon"></span>'),self._fullscreenResizeHandler&&(K(window).unbind("resize",self._fullscreenResizeHandler),self._fullscreenResizeHandler=null),initResize(),fullscreenMode?(self._fullscreenResizeHandler=function(){self.isCreated&&self.resize(_docElement().clientWidth,_docElement().clientHeight,!1)},K(window).bind("resize",self._fullscreenResizeHandler),toolbar.select("fullscreen"),statusbar.first().css("visibility","hidden"),statusbar.last().css("visibility","hidden")):(_GECKO&&K(window).bind("scroll",function(){self._scrollPos=_getScrollPos()}),self.resizeType>0?_drag({moveEl:container,clickEl:statusbar,moveFn:function(x,y,width,height,diffX,diffY){height+=diffY,self.resize(null,height)}}):statusbar.first().css("visibility","hidden"),2===self.resizeType?_drag({moveEl:container,clickEl:statusbar.last(),moveFn:function(x,y,width,height,diffX,diffY){width+=diffX,height+=diffY,self.resize(width,height)}}):statusbar.last().css("visibility","hidden")),self},remove:function(){var self=this;return self.isCreated?(self.beforeRemove(),self.srcElement.data("kindeditor",""),self.menu&&self.hideMenu(),_each(self.dialogs,function(){self.hideDialog()}),K(document).unbind("mousedown",self._docMousedownFn),self.toolbar.remove(),self.edit.remove(),self.statusbar.last().unbind(),self.statusbar.unbind(),self.container.remove(),self.container=self.toolbar=self.edit=self.menu=null,self.dialogs=[],self.isCreated=!1,self):self},resize:function(width,height,updateProp){var self=this;return updateProp=_undef(updateProp,!0),width&&(/%/.test(width)||(width=_removeUnit(width),width=width<self.minWidth?self.minWidth:width),self.container.css("width",_addUnit(width)),updateProp&&(self.width=_addUnit(width))),height&&(height=_removeUnit(height),editHeight=_removeUnit(height)-self.toolbar.div.height()-self.statusbar.height(),editHeight=editHeight<self.minHeight?self.minHeight:editHeight,self.edit.setHeight(editHeight),updateProp&&(self.height=_addUnit(height))),self},select:function(){return this.isCreated&&this.cmd.select(),this},html:function(val){var self=this;return val===undefined?self.isCreated?self.edit.html():_elementVal(self.srcElement):(self.isCreated?self.edit.html(val):_elementVal(self.srcElement,val),self.isCreated&&self.cmd.selection(),self)},fullHtml:function(){return this.isCreated?this.edit.html(undefined,!0):""},text:function(val){var self=this;return val===undefined?_trim(self.html().replace(/<(?!img|embed).*?>/gi,"").replace(/&nbsp;/gi," ")):self.html(_escape(val))},isEmpty:function(){return""===_trim(this.text().replace(/\r\n|\n|\r/,""))},isDirty:function(){return _trim(this.initContent.replace(/\r\n|\n|\r|t/g,""))!==_trim(this.html().replace(/\r\n|\n|\r|t/g,""))},selectedHtml:function(){var val=this.isCreated?this.cmd.range.html():"";return val=_removeBookmarkTag(_removeTempTag(val))},count:function(mode){var self=this;return mode=(mode||"html").toLowerCase(),"html"===mode?self.html().length:"text"===mode?self.text().replace(/<(?:img|embed).*?>/gi,"K").replace(/\r\n|\n|\r/g,"").length:0},exec:function(key){key=key.toLowerCase();var self=this,cmd=self.cmd,changeFlag=_inArray(key,"selectall,copy,paste,print".split(","))<0;return changeFlag&&self.addBookmark(!1),cmd[key].apply(cmd,_toArray(arguments,1)),changeFlag&&(self.updateState(),self.addBookmark(!1),self.options.afterChange&&self.options.afterChange.call(self)),self},insertHtml:function(val,quickMode){return this.isCreated?(val=this.beforeSetHtml(val),this.exec("inserthtml",val,quickMode),this):this},appendHtml:function(val){if(this.html(this.html()+val),this.isCreated){var cmd=this.cmd;cmd.range.selectNodeContents(cmd.doc.body).collapse(!1),cmd.select()}return this},sync:function(){return _elementVal(this.srcElement,this.html()),this},focus:function(){return this.isCreated?this.edit.focus():this.srcElement[0].focus(),this},blur:function(){return this.isCreated?this.edit.blur():this.srcElement[0].blur(),this},addBookmark:function(checkSize){checkSize=_undef(checkSize,!0);var bookmark,self=this,edit=self.edit,body=edit.doc.body,html=_removeTempTag(body.innerHTML);if(checkSize&&self._undoStack.length>0){var prev=self._undoStack[self._undoStack.length-1];if(Math.abs(html.length-_removeBookmarkTag(prev.html).length)<self.minChangeSize)return self}if(edit.designMode&&!self._firstAddBookmark){var range=self.cmd.range;bookmark=range.createBookmark(!0),bookmark.html=_removeTempTag(body.innerHTML),range.moveToBookmark(bookmark)}else bookmark={html:html};return self._firstAddBookmark=!1,_addBookmarkToStack(self._undoStack,bookmark),self},undo:function(){return _undoToRedo.call(this,this._undoStack,this._redoStack)},redo:function(){return _undoToRedo.call(this,this._redoStack,this._undoStack)},fullscreen:function(bool){return this.fullscreenMode=bool===undefined?!this.fullscreenMode:bool,this.addBookmark(!1),this.remove().create()},readonly:function(isReadonly){isReadonly=_undef(isReadonly,!0);var self=this,edit=self.edit,doc=edit.doc;self.designMode?self.toolbar.disableAll(isReadonly,[]):_each(self.noDisableItems,function(){self.toolbar[isReadonly?"disable":"enable"](this)}),_IE?doc.body.contentEditable=!isReadonly:doc.designMode=isReadonly?"off":"on",edit.textarea[0].disabled=isReadonly},createMenu:function(options){var self=this,name=options.name,knode=self.toolbar.get(name),pos=knode.pos();return options.x=pos.x,options.y=pos.y+knode.height(),options.z=self.options.zIndex,options.shadowMode=_undef(options.shadowMode,self.shadowMode),options.selectedColor!==undefined?(options.cls="ke-colorpicker-"+self.themeType,options.noColor=self.lang("noColor"),self.menu=_colorpicker(options)):(options.cls="ke-menu-"+self.themeType,options.centerLineMode=!1,self.menu=_menu(options)),self.menu},hideMenu:function(){return this.menu.remove(),this.menu=null,this},hideContextmenu:function(){return this.contextmenu.remove(),this.contextmenu=null,this},createDialog:function(options){{var self=this;options.name}if(options.z=self.options.zIndex,options.shadowMode=_undef(options.shadowMode,self.shadowMode),options.closeBtn=_undef(options.closeBtn,{name:self.lang("close"),click:function(){self.hideDialog(),_IE&&self.cmd&&self.cmd.select()}}),options.noBtn=_undef(options.noBtn,{name:self.lang(options.yesBtn?"no":"close"),click:function(){self.hideDialog(),_IE&&self.cmd&&self.cmd.select()}}),"page"!=self.dialogAlignType&&(options.alignEl=self.container),options.cls="ke-dialog-"+self.themeType,self.dialogs.length>0){var firstDialog=self.dialogs[0],parentDialog=self.dialogs[self.dialogs.length-1];firstDialog.setMaskIndex(parentDialog.z+2),options.z=parentDialog.z+3,options.showMask=!1}var dialog=_dialog(options);return self.dialogs.push(dialog),dialog},hideDialog:function(){var self=this;if(self.dialogs.length>0&&self.dialogs.pop().remove(),self.dialogs.length>0){var firstDialog=self.dialogs[0],parentDialog=self.dialogs[self.dialogs.length-1];firstDialog.setMaskIndex(parentDialog.z-1)}return self},errorDialog:function(html){var self=this,dialog=self.createDialog({width:750,title:self.lang("uploadError"),body:'<div style="padding:10px 20px;"><iframe frameborder="0" style="width:708px;height:400px;"></iframe></div>'}),iframe=K("iframe",dialog.div),doc=K.iframeDoc(iframe);return doc.open(),doc.write(html),doc.close(),K(doc.body).css("background-color","#FFF"),iframe[0].contentWindow.focus(),self}},_instances=[],K.remove=function(expr){_eachEditor(expr,function(i){this.remove(),_instances.splice(i,1)})},K.sync=function(expr){_eachEditor(expr,function(){this.sync()})},K.html=function(expr,val){_eachEditor(expr,function(){this.html(val)})},K.insertHtml=function(expr,val){_eachEditor(expr,function(){this.insertHtml(val)})},K.appendHtml=function(expr,val){_eachEditor(expr,function(){this.appendHtml(val)})},_IE&&7>_V&&_nativeCommand(document,"BackgroundImageCache",!0),K.EditorClass=KEditor,K.editor=_editor,K.create=_create,K.instances=_instances,K.plugin=_plugin,K.lang=_lang,_plugin("core",function(K){var self=this,shortcutKeys={undo:"Z",redo:"Y",bold:"B",italic:"I",underline:"U",print:"P",selectall:"A"};if(self.afterSetHtml(function(){self.options.afterChange&&self.options.afterChange.call(self)}),self.afterCreate(function(){if("form"==self.syncType){for(var el=K(self.srcElement),hasForm=!1;el=el.parent();)if("form"==el.name){hasForm=!0;break}if(hasForm){el.bind("submit",function(){self.sync(),K(window).bind("unload",function(){self.edit.textarea.remove()})});var resetBtn=K('[type="reset"]',el);resetBtn.click(function(){self.html(self.initContent),self.cmd.selection()}),self.beforeRemove(function(){el.unbind(),resetBtn.unbind()})}}}),self.clickToolbar("source",function(){self.edit.designMode?(self.toolbar.disableAll(!0),self.edit.design(!1),self.toolbar.select("source")):(self.toolbar.disableAll(!1),self.edit.design(!0),self.toolbar.unselect("source"),_GECKO?setTimeout(function(){self.cmd.selection()},0):self.cmd.selection()),self.designMode=self.edit.designMode}),self.afterCreate(function(){self.designMode||self.toolbar.disableAll(!0).select("source")}),self.clickToolbar("fullscreen",function(){self.fullscreen()}),self.fullscreenShortcut){var loaded=!1;self.afterCreate(function(){if(K(self.edit.doc,self.edit.textarea).keyup(function(e){27==e.which&&setTimeout(function(){self.fullscreen()},0)}),loaded){if(_IE&&!self.designMode)return;self.focus()}loaded||(loaded=!0)})}_each("undo,redo".split(","),function(i,name){shortcutKeys[name]&&self.afterCreate(function(){_ctrl(this.edit.doc,shortcutKeys[name],function(){self.clickToolbar(name)})}),self.clickToolbar(name,function(){self[name]()})}),self.clickToolbar("formatblock",function(){var blocks=self.lang("formatblock.formatBlock"),heights={h1:28,h2:24,h3:18,H4:14,p:12},curVal=self.cmd.val("formatblock"),menu=self.createMenu({name:"formatblock",width:"en"==self.langType?200:150});_each(blocks,function(key,val){var style="font-size:"+heights[key]+"px;";"h"===key.charAt(0)&&(style+="font-weight:bold;"),menu.addItem({title:'<span style="'+style+'" unselectable="on">'+val+"</span>",height:heights[key]+12,checked:curVal===key||curVal===val,click:function(){self.select().exec("formatblock","<"+key+">").hideMenu()}})})}),self.clickToolbar("fontname",function(){var curVal=self.cmd.val("fontname"),menu=self.createMenu({name:"fontname",width:150});_each(self.lang("fontname.fontName"),function(key,val){menu.addItem({title:'<span style="font-family: '+key+';" unselectable="on">'+val+"</span>",checked:curVal===key.toLowerCase()||curVal===val.toLowerCase(),click:function(){self.exec("fontname",key).hideMenu()}})})}),self.clickToolbar("fontsize",function(){var curVal=self.cmd.val("fontsize"),menu=self.createMenu({name:"fontsize",width:150});_each(self.fontSizeTable,function(i,val){menu.addItem({title:'<span style="font-size:'+val+';" unselectable="on">'+val+"</span>",height:_removeUnit(val)+12,checked:curVal===val,click:function(){self.exec("fontsize",val).hideMenu()}})})}),_each("forecolor,hilitecolor".split(","),function(i,name){self.clickToolbar(name,function(){self.createMenu({name:name,selectedColor:self.cmd.val(name)||"default",colors:self.colorTable,click:function(color){self.exec(name,color).hideMenu()}})})}),_each("cut,copy,paste".split(","),function(i,name){self.clickToolbar(name,function(){self.focus();try{self.exec(name,null)}catch(e){alert(self.lang(name+"Error"))}})}),self.clickToolbar("about",function(){var html='<div style="margin:20px;"><div>KindEditor '+_VERSION+'</div><div>Copyright &copy; <a href="http://www.kindsoft.net/" target="_blank">kindsoft.net</a> All rights reserved.</div></div>';self.createDialog({name:"about",width:350,title:self.lang("about"),body:html})}),self.plugin.getSelectedLink=function(){return self.cmd.commonAncestor("a")},self.plugin.getSelectedImage=function(){return _getImageFromRange(self.edit.cmd.range,function(img){return!/^ke-\w+$/i.test(img[0].className)})},self.plugin.getSelectedFlash=function(){return _getImageFromRange(self.edit.cmd.range,function(img){return"ke-flash"==img[0].className})},self.plugin.getSelectedMedia=function(){return _getImageFromRange(self.edit.cmd.range,function(img){return"ke-media"==img[0].className||"ke-rm"==img[0].className})},self.plugin.getSelectedAnchor=function(){return _getImageFromRange(self.edit.cmd.range,function(img){return"ke-anchor"==img[0].className})},_each("link,image,flash,media,anchor".split(","),function(i,name){var uName=name.charAt(0).toUpperCase()+name.substr(1);_each("edit,delete".split(","),function(j,val){self.addContextmenu({title:self.lang(val+uName),click:function(){self.loadPlugin(name,function(){self.plugin[name][val](),self.hideMenu()})},cond:self.plugin["getSelected"+uName],width:150,iconClass:"edit"==val?"ke-icon-"+name:undefined})}),self.addContextmenu({title:"-"})}),self.plugin.getSelectedTable=function(){return self.cmd.commonAncestor("table")},self.plugin.getSelectedRow=function(){return self.cmd.commonAncestor("tr")},self.plugin.getSelectedCell=function(){return self.cmd.commonAncestor("td")},_each("prop,cellprop,colinsertleft,colinsertright,rowinsertabove,rowinsertbelow,rowmerge,colmerge,rowsplit,colsplit,coldelete,rowdelete,insert,delete".split(","),function(i,val){var cond=_inArray(val,["prop","delete"])<0?self.plugin.getSelectedCell:self.plugin.getSelectedTable;self.addContextmenu({title:self.lang("table"+val),click:function(){self.loadPlugin("table",function(){self.plugin.table[val](),self.hideMenu()})},cond:cond,width:170,iconClass:"ke-icon-table"+val})}),self.addContextmenu({title:"-"}),_each("selectall,justifyleft,justifycenter,justifyright,justifyfull,insertorderedlist,insertunorderedlist,indent,outdent,subscript,superscript,hr,print,bold,italic,underline,strikethrough,removeformat,unlink".split(","),function(i,name){shortcutKeys[name]&&self.afterCreate(function(){_ctrl(this.edit.doc,shortcutKeys[name],function(){self.cmd.selection(),self.clickToolbar(name)})}),self.clickToolbar(name,function(){self.focus().exec(name,null)})}),self.afterCreate(function(){function movePastedData(){cmd.range.moveToBookmark(bookmark),cmd.select(),_WEBKIT&&(K("div."+cls,div).each(function(){K(this).after("<br />").remove(!0)}),K("span.Apple-style-span",div).remove(!0),K("span.Apple-tab-span",div).remove(!0),K("span[style]",div).each(function(){"nowrap"==K(this).css("white-space")&&K(this).remove(!0)}),K("meta",div).remove());var html=div[0].innerHTML;div.remove(),""!==html&&(_WEBKIT&&(html=html.replace(/(<br>)\1/gi,"$1")),2===self.pasteType&&(html=html.replace(/(<(?:p|p\s[^>]*)>) *(<\/p>)/gi,""),/schemas-microsoft-com|worddocument|mso-\w+/i.test(html)?html=_clearMsWord(html,self.filterMode?self.htmlTags:K.options.htmlTags):(html=_formatHtml(html,self.filterMode?self.htmlTags:null),html=self.beforeSetHtml(html))),1===self.pasteType&&(html=html.replace(/&nbsp;/gi," "),html=html.replace(/\n\s*\n/g,"\n"),html=html.replace(/<br[^>]*>/gi,"\n"),html=html.replace(/<\/p><p[^>]*>/gi,"\n"),html=html.replace(/<[^>]+>/g,""),html=html.replace(/ {2}/g," &nbsp;"),"p"==self.newlineTag?/\n/.test(html)&&(html=html.replace(/^/,"<p>").replace(/$/,"<br /></p>").replace(/\n/g,"<br /></p><p>")):html=html.replace(/\n/g,"<br />$&")),self.insertHtml(html,!0))}var cmd,bookmark,div,doc=self.edit.doc,cls="__kindeditor_paste__",pasting=!1;K(doc.body).bind("paste",function(e){if(0===self.pasteType)return e.stop(),void 0;if(!pasting){if(pasting=!0,K("div."+cls,doc).remove(),cmd=self.cmd.selection(),bookmark=cmd.range.createBookmark(),div=K('<div class="'+cls+'"></div>',doc).css({position:"absolute",width:"1px",height:"1px",overflow:"hidden",left:"-1981px",top:K(bookmark.start).pos().y+"px","white-space":"nowrap"}),K(doc.body).append(div),_IE){var rng=cmd.range.get(!0);rng.moveToElementText(div[0]),rng.select(),rng.execCommand("paste"),e.preventDefault()}else cmd.range.selectNodeContents(div[0]),cmd.select();setTimeout(function(){movePastedData(),pasting=!1},0)}})}),self.beforeGetHtml(function(html){return _IE&&8>=_V&&(html=html.replace(/<div\s+[^>]*data-ke-input-tag="([^"]*)"[^>]*>([\s\S]*?)<\/div>/gi,function(full,tag){return unescape(tag)}),html=html.replace(/(<input)((?:\s+[^>]*)?>)/gi,function($0,$1,$2){return/\s+type="[^"]+"/i.test($0)?$0:$1+' type="text"'+$2})),html.replace(/(<(?:noscript|noscript\s[^>]*)>)([\s\S]*?)(<\/noscript>)/gi,function($0,$1,$2,$3){return $1+_unescape($2).replace(/\s+/g," ")+$3}).replace(/<img[^>]*class="?ke-(flash|rm|media)"?[^>]*>/gi,function(full){var imgAttrs=_getAttrList(full),styles=_getCssList(imgAttrs.style||""),attrs=_mediaAttrs(imgAttrs["data-ke-tag"]),width=_undef(styles.width,""),height=_undef(styles.height,"");return/px/i.test(width)&&(width=_removeUnit(width)),/px/i.test(height)&&(height=_removeUnit(height)),attrs.width=_undef(imgAttrs.width,width),attrs.height=_undef(imgAttrs.height,height),_mediaEmbed(attrs)}).replace(/<img[^>]*class="?ke-anchor"?[^>]*>/gi,function(full){var imgAttrs=_getAttrList(full);return'<a name="'+unescape(imgAttrs["data-ke-name"])+'"></a>'}).replace(/<div\s+[^>]*data-ke-script-attr="([^"]*)"[^>]*>([\s\S]*?)<\/div>/gi,function(full,attr,code){return"<script"+unescape(attr)+">"+unescape(code)+"</script>"}).replace(/<div\s+[^>]*data-ke-noscript-attr="([^"]*)"[^>]*>([\s\S]*?)<\/div>/gi,function(full,attr,code){return"<noscript"+unescape(attr)+">"+unescape(code)+"</noscript>"}).replace(/(<[^>]*)data-ke-src="([^"]*)"([^>]*>)/gi,function(full,start,src){return full=full.replace(/(\s+(?:href|src)=")[^"]*(")/i,function($0,$1,$2){return $1+_unescape(src)+$2}),full=full.replace(/\s+data-ke-src="[^"]*"/i,"")}).replace(/(<[^>]+\s)data-ke-(on\w+="[^"]*"[^>]*>)/gi,function(full,start,end){return start+end})}),self.beforeSetHtml(function(html){return _IE&&8>=_V&&(html=html.replace(/<input[^>]*>|<(select|button)[^>]*>[\s\S]*?<\/\1>/gi,function(full){var attrs=_getAttrList(full),styles=_getCssList(attrs.style||"");return"none"==styles.display?'<div class="ke-display-none" data-ke-input-tag="'+escape(full)+'"></div>':full})),html.replace(/<embed[^>]*type="([^"]+)"[^>]*>(?:<\/embed>)?/gi,function(full){var attrs=_getAttrList(full);return attrs.src=_undef(attrs.src,""),attrs.width=_undef(attrs.width,0),attrs.height=_undef(attrs.height,0),_mediaImg(self.themesPath+"common/blank.gif",attrs)}).replace(/<a[^>]*name="([^"]+)"[^>]*>(?:<\/a>)?/gi,function(full){var attrs=_getAttrList(full);return attrs.href!==undefined?full:'<img class="ke-anchor" src="'+self.themesPath+'common/anchor.gif" data-ke-name="'+escape(attrs.name)+'" />'}).replace(/<script([^>]*)>([\s\S]*?)<\/script>/gi,function(full,attr,code){return'<div class="ke-script" data-ke-script-attr="'+escape(attr)+'">'+escape(code)+"</div>"}).replace(/<noscript([^>]*)>([\s\S]*?)<\/noscript>/gi,function(full,attr,code){return'<div class="ke-noscript" data-ke-noscript-attr="'+escape(attr)+'">'+escape(code)+"</div>"}).replace(/(<[^>]*)(href|src)="([^"]*)"([^>]*>)/gi,function(full,start,key,src,end){return full.match(/\sdata-ke-src="[^"]*"/i)?full:full=start+key+'="'+src+'" data-ke-src="'+_escape(src)+'"'+end}).replace(/(<[^>]+\s)(on\w+="[^"]*"[^>]*>)/gi,function(full,start,end){return start+"data-ke-"+end}).replace(/<table[^>]*\s+border="0"[^>]*>/gi,function(full){return full.indexOf("ke-zeroborder")>=0?full:_addClassToTag(full,"ke-zeroborder")})})})}}(window);